<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0b1020">
    <title>Nanobanana Linker - AI Prompt Manager</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.webmanifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icon-512.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Verdana', sans-serif;
        }

        .app-gradient {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .character-slot {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .character-slot.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .image-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .image-preview:hover {
            transform: scale(1.1);
        }

        .tab-button {
            position: relative;
            padding: 12px 24px;
            color: #64748b;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: #3b82f6;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #3b82f6;
            border-radius: 3px 3px 0 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        input[type="checkbox"]:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* V2 Styles */
        .mode-btn {
            background: #f1f5f9;
            color: #64748b;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .db-subtab {
            color: #64748b;
            position: relative;
        }

        .db-subtab.active {
            color: #3b82f6;
        }

        .db-subtab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #3b82f6;
        }

        .character-card {
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .character-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .character-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .situation-btn.active,
        .action-btn.active {
            border-color: #3b82f6;
            background: #eff6ff;
            font-weight: 600;
        }

        /* Accordion (V5) */
        .accordion {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .accordion-header {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 1.125rem;
            transition: all 0.3s ease;
        }

        .accordion-header:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8b 100%);
        }

        .accordion-header .icon {
            transition: transform 0.3s ease;
        }

        .accordion-header.collapsed .icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            padding: 1.5rem;
            background: white;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .accordion-content.collapsed {
            max-height: 0;
            padding: 0 1.5rem;
        }

        /* V9: Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #e5e7eb;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .bottom-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            color: #64748b;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            background: none;
        }

        .bottom-nav-item .icon {
            font-size: 1.5rem;
            margin-bottom: 2px;
        }

        .bottom-nav-item.active {
            color: #3b82f6;
        }

        .bottom-nav-item:active {
            transform: scale(0.95);
        }

        #app {
            padding-bottom: 70px;
        }

        /* V9: Sync Button */
        .sync-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .sync-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
    </style>
</head>
<body class="app-gradient min-h-screen">
    <!-- Main Container -->
    <div id="app" class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <header class="mb-8 fade-in">
            <div class="flex items-center justify-between mb-2">
                <div class="flex-1"></div>
                <div class="flex-1 text-center">
                    <h1 class="text-4xl font-bold text-blue-600">ğŸŒ Nanobanana Linker</h1>
                </div>
                <div class="flex-1 flex justify-end">
                    <button id="sync-button" class="sync-btn flex items-center space-x-2">
                        <span>â˜</span>
                        <span>Sync</span>
                    </button>
                </div>
            </div>
            <p class="text-gray-600 text-center">AIç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ãƒ„ãƒ¼ãƒ«</p>
        </header>


        <!-- Tab Content -->
        <div id="tab-content">
            <!-- Generator Hub Tab (V2 Syntax Builder) -->
            <div id="generator-tab" class="tab-content fade-in">
                <!-- Mode Selection -->
                <div class="card p-4 mb-6">
                    <div class="flex justify-center space-x-4">
                        <button class="mode-btn active px-8 py-3 rounded-lg font-semibold transition" data-mode="solo">
                            ğŸ‘¤ Solo
                        </button>
                        <button class="mode-btn px-8 py-3 rounded-lg font-semibold transition" data-mode="duo">
                            ğŸ‘¥ Duo/Group
                        </button>
                        <button class="mode-btn px-8 py-3 rounded-lg font-semibold transition" data-mode="comic">
                            ğŸ“– Comic
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Builder Section -->
                    <div class="lg:col-span-2 space-y-4">
                        <!-- Accordion 1: Character Settings -->
                        <div class="accordion">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <span>ğŸ‘¤ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š</span>
                                <span class="icon">â–¼</span>
                            </div>
                            <div class="accordion-content">
                                <div id="character-selector" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-6">
                                    <div class="text-center text-gray-400 col-span-full py-8">
                                        ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„
                                    </div>
                                </div>

                                <!-- V9: Costume Selection -->
                                <div id="costume-selection-section" class="mt-6 pt-6 border-t border-gray-200">
                                    <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ‘— è¡£è£…é¸æŠ (Costume)</h3>
                                    <div class="mb-3">
                                        <label class="block text-sm text-gray-600 mb-2">â€»é¸æŠã™ã‚‹ã¨ã€ã‚­ãƒ£ãƒ©å›ºæœ‰ã®è¡£è£…ã‚¿ã‚°ã®ä»£ã‚ã‚Šã«ã€ã“ã®è¡£è£…ãŒé©ç”¨ã•ã‚Œã¾ã™</label>
                                        <select id="costume-selector" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                            <option value="">è¡£è£…ã‚’é¸æŠã—ãªã„ï¼ˆã‚­ãƒ£ãƒ©å›ºæœ‰ã®è¡£è£…ã‚’ä½¿ç”¨ï¼‰</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- V8: Per-Character Advanced Settings -->
                        <div id="per-character-advanced-settings" class="space-y-4">
                            <!-- Dynamically populated when characters are selected -->
                        </div>

                        <!-- Accordion 2: Scene & Props (V6) -->
                        <div class="accordion">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <span>ğŸ¬ Scene & Props ï¼ˆã‚·ãƒ¼ãƒ³ãƒ»å°ç‰©ãƒ»æ™‚é–“å¸¯ï¼‰</span>
                                <span class="icon">â–¼</span>
                            </div>
                            <div class="accordion-content">
                                <div class="space-y-6">
                                    <!-- Where? Situation Selection -->
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ“ Where? ï¼ˆå ´æ‰€ï¼‰</h3>
                                        <div id="situation-selector" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                            <button class="situation-btn p-3 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition" data-id="">
                                                æŒ‡å®šãªã—
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Doing What? Action Selection -->
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ¬ Doing What? ï¼ˆè¡Œå‹•ï¼‰</h3>
                                        <div id="action-selector" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                                            <button class="action-btn p-3 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition" data-id="">
                                                æŒ‡å®šãªã—
                                            </button>
                                        </div>
                                        <label class="block text-gray-700 font-semibold mb-2">ãƒ•ãƒªãƒ¼å…¥åŠ›ï¼ˆæ—¥æœ¬èªå¯ï¼‰</label>
                                        <textarea id="custom-action-input" rows="2" placeholder="ä¾‹ï¼šä¸¸ã€…ã—ã¦ã„ã‚‹ã¨ã“ã‚ã€ç¥ˆã£ã¦ã„ã‚‹ã€ãªã©"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>

                                    <!-- Props (V6) -->
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ Props ï¼ˆå°ç‰©ï¼‰</h3>
                                        <div id="props-selector" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                                            <button class="props-btn p-3 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition" data-id="">
                                                æŒ‡å®šãªã—
                                            </button>
                                        </div>
                                        <label class="block text-gray-700 font-semibold mb-2">ãƒ•ãƒªãƒ¼å…¥åŠ›ï¼ˆå°ç‰©ï¼‰</label>
                                        <textarea id="custom-props-input" rows="2" placeholder="ä¾‹ï¼šå‰£ã€æœ¬ã€èŠ±æŸã€ãªã©"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>

                                    <!-- Time of Day (V6) -->
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸŒ… When? ï¼ˆæ™‚é–“å¸¯ï¼‰</h3>
                                        <select id="time-of-day-selector" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                            <option value="">æŒ‡å®šãªã—</option>
                                            <option value="morning glow, sunrise">ğŸŒ… æœç„¼ã‘ (Morning Glow, Sunrise)</option>
                                            <option value="morning, daylight">â˜€ï¸ æœ (Morning, Daylight)</option>
                                            <option value="noon, sunny">ğŸŒ æ˜¼ (Noon, Sunny)</option>
                                            <option value="sunset, dusk">ğŸŒ‡ å¤•æ–¹ (Sunset, Dusk)</option>
                                            <option value="night, moonlight">ğŸŒ™ å¤œ (Night, Moonlight)</option>
                                            <option value="midnight, starry sky">ğŸŒŒ æ·±å¤œ (Midnight, Starry Sky)</option>
                                        </select>
                                    </div>

                                    <!-- Options (Duo Mode) -->
                                    <div class="hidden" id="duo-options">
                                        <h3 class="text-lg font-bold text-gray-800 mb-3">ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h3>
                                        <label class="flex items-center space-x-3 cursor-pointer">
                                            <input type="checkbox" id="auto-person-tags" checked class="w-5 h-5 rounded">
                                            <span class="text-gray-700">äººæ•°ã‚¿ã‚°ã‚’è‡ªå‹•è¿½åŠ ï¼ˆ2boys, multiple girlsãªã©ï¼‰</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Accordion 3: Style & Color (V6) -->
                        <div class="accordion">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <span>ğŸ¨ Style & Color ï¼ˆç”»é¢¨ãƒ»è‰²ãƒ»ç·šãƒ»ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰</span>
                                <span class="icon">â–¼</span>
                            </div>
                            <div class="accordion-content">
                                <div class="space-y-6">
                                    <!-- Art Styles (Multi-select V6) -->
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-3">ğŸ–¼ï¸ ã‚¢ãƒ¼ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                                        <div id="art-style-checkboxes" class="space-y-2 max-h-48 overflow-y-auto p-3 border border-gray-300 rounded-lg bg-gray-50">
                                            <div class="text-sm text-gray-400">ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>
                                        </div>
                                    </div>

                                    <!-- Lineart Strength (V6) -->
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-3">âœï¸ ç·šã®å¼·å¼±</label>
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                            <label class="flex items-center space-x-2">
                                                <input type="radio" name="lineart-strength" value="" checked>
                                                <span class="text-sm">æŒ‡å®šãªã—</span>
                                            </label>
                                            <label class="flex items-center space-x-2">
                                                <input type="radio" name="lineart-strength" value="outline">
                                                <span class="text-sm">ç¸å–ã‚Šã‚ã‚Š</span>
                                            </label>
                                            <label class="flex items-center space-x-2">
                                                <input type="radio" name="lineart-strength" value="thick outline">
                                                <span class="text-sm">å¤ªã„ç¸å–ã‚Š</span>
                                            </label>
                                            <label class="flex items-center space-x-2">
                                                <input type="radio" name="lineart-strength" value="borderless">
                                                <span class="text-sm">ç¸å–ã‚Šãªã—</span>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Color Palette -->
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-3">ğŸ¨ ã‚«ãƒ©ãƒ¼è¨­å®š</label>
                                        <div class="space-y-3">
                                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                                <label class="flex items-center space-x-2">
                                                    <input type="radio" name="color-mode" value="none" checked>
                                                    <span class="text-sm">æŒ‡å®šãªã—</span>
                                                </label>
                                                <label class="flex items-center space-x-2">
                                                    <input type="radio" name="color-mode" value="monotone">
                                                    <span class="text-sm">Monotone</span>
                                                </label>
                                                <label class="flex items-center space-x-2">
                                                    <input type="radio" name="color-mode" value="two-tone">
                                                    <span class="text-sm">Two-tone</span>
                                                </label>
                                                <label class="flex items-center space-x-2">
                                                    <input type="radio" name="color-mode" value="background">
                                                    <span class="text-sm">Background</span>
                                                </label>
                                                <label class="flex items-center space-x-2">
                                                    <input type="radio" name="color-mode" value="theme">
                                                    <span class="text-sm">Theme Color</span>
                                                </label>
                                            </div>

                                            <div id="color-picker-container" class="space-y-2">
                                                <div class="flex items-center space-x-3">
                                                    <label class="text-sm font-semibold w-24">Color 1:</label>
                                                    <input type="color" id="color-1" value="#FF0000" class="w-16 h-10 rounded border-2 border-gray-300">
                                                    <span id="color-1-hex" class="text-sm text-gray-600">#FF0000</span>
                                                </div>
                                                <div class="flex items-center space-x-3 hidden" id="color-2-row">
                                                    <label class="text-sm font-semibold w-24">Color 2:</label>
                                                    <input type="color" id="color-2" value="#0000FF" class="w-16 h-10 rounded border-2 border-gray-300">
                                                    <span id="color-2-hex" class="text-sm text-gray-600">#0000FF</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Aspect Ratio -->
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2">ğŸ“ ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”</label>
                                        <select id="aspect-ratio-selector" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                            <option value="">æŒ‡å®šãªã—</option>
                                            <option value="1:1">1:1 (Square)</option>
                                            <option value="3:4">3:4 (Portrait)</option>
                                            <option value="4:3">4:3 (Landscape)</option>
                                            <option value="16:9">16:9 (Wide)</option>
                                            <option value="9:16">9:16 (Vertical)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Preview & Actions Section -->
                    <div class="space-y-6">
                        <!-- Preview -->
                        <div class="card p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                            <div id="prompt-preview" class="bg-gray-50 p-4 rounded-lg text-sm text-gray-700 min-h-32 max-h-64 overflow-y-auto scrollbar-thin font-mono whitespace-pre-wrap">
                                ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                            </div>
                        </div>

                        <!-- Reference Images -->
                        <div class="card p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">å‚è€ƒç”»åƒ</h3>
                            <div id="reference-images" class="grid grid-cols-3 gap-2 max-h-64 overflow-y-auto scrollbar-thin">
                                <div class="text-center text-gray-400 col-span-3 py-8 text-sm">
                                    ã‚­ãƒ£ãƒ©ã‚’é¸æŠã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="card p-6 space-y-3">
                            <button id="copy-prompt-btn" class="btn-primary w-full text-white px-6 py-3 rounded-lg font-semibold">
                                ğŸ“‹ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼
                            </button>
                            <button id="save-images-btn" class="bg-green-500 hover:bg-green-600 w-full text-white px-6 py-3 rounded-lg font-semibold transition">
                                ğŸ’¾ ç”»åƒã‚’ä¿å­˜
                            </button>
                        </div>

                        <!-- Output Format (V4) -->
                        <div class="card p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">å‡ºåŠ›å½¢å¼ (V4)</h3>
                            <select id="output-format" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-3">
                                <option value="standard">ğŸ“‹ Standard Tags (è‹±èªã‚¿ã‚°)</option>
                                <option value="simple-jp">ğŸ‡¯ğŸ‡µ Simple JP (æ—¥æœ¬èª)</option>
                                <option value="natural">ğŸ“ Natural Prompt (è‹±æ–‡)</option>
                            </select>

                            <label class="flex items-center space-x-3 cursor-pointer p-3 bg-yellow-50 rounded-lg border-2 border-yellow-300">
                                <input type="checkbox" id="strict-source-mode" class="w-5 h-5 rounded">
                                <span class="text-gray-800 text-sm font-semibold">ğŸ”’ Strict Source Modeï¼ˆç”»åƒã‚’å”¯ä¸€ã®ã‚½ãƒ¼ã‚¹ã«ã™ã‚‹ï¼‰</span>
                            </label>
                        </div>

                        <!-- Quality Presets -->
                        <div class="card p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">å“è³ªè¨­å®š</h3>
                            <div class="space-y-3">
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="checkbox" id="quality-positive-toggle" checked class="w-5 h-5 rounded">
                                    <span class="text-gray-700 text-sm">é«˜ç”»è³ªåŒ–ã‚¿ã‚° (Positive)</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="checkbox" id="quality-negative-toggle" checked class="w-5 h-5 rounded">
                                    <span class="text-gray-700 text-sm">ãƒã‚¬ãƒ†ã‚£ãƒ–ã‚¿ã‚° (Negative)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Story Mode Tab (V3) -->
            <div id="story-tab" class="tab-content hidden">
                <!-- Project List View -->
                <div id="project-list-view">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">ğŸ“š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</h2>
                            <button id="add-project-btn" class="btn-primary text-white px-4 py-2 rounded-lg">
                                â• æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
                            </button>
                        </div>
                        <div id="project-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                </div>

                <!-- Project Detail View (Pages) -->
                <div id="project-detail-view" class="hidden">
                    <div class="card p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <button id="back-to-projects" class="text-blue-500 hover:text-blue-700 font-semibold">
                                â† ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã«æˆ»ã‚‹
                            </button>
                            <div class="space-x-2">
                                <button id="edit-project-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                    âœï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š
                                </button>
                                <button id="delete-project-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                                    ğŸ—‘ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤
                                </button>
                            </div>
                        </div>

                        <div id="project-info" class="mb-4">
                            <h2 id="project-title-display" class="text-3xl font-bold text-gray-800 mb-2"></h2>
                            <div id="project-plot-display" class="text-gray-600 whitespace-pre-wrap mb-4"></div>

                            <!-- Style Presets -->
                            <div class="flex flex-wrap gap-3 mb-4">
                                <div class="flex items-center space-x-2 bg-gray-100 px-3 py-1 rounded">
                                    <input type="checkbox" id="style-monochrome" class="style-preset">
                                    <label class="text-sm font-semibold">â¬› Monochrome Manga</label>
                                </div>
                                <div class="flex items-center space-x-2 bg-gray-100 px-3 py-1 rounded">
                                    <input type="checkbox" id="style-fullcolor" class="style-preset">
                                    <label class="text-sm font-semibold">ğŸ¨ Full Color</label>
                                </div>
                                <div class="flex items-center space-x-2 bg-gray-100 px-3 py-1 rounded">
                                    <input type="checkbox" id="style-4koma" class="style-preset">
                                    <label class="text-sm font-semibold">ğŸ“„ 4-Koma</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pages -->
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">ğŸ“„ ãƒšãƒ¼ã‚¸ç®¡ç†</h3>
                            <button id="add-page-btn" class="btn-primary text-white px-4 py-2 rounded-lg">
                                â• ãƒšãƒ¼ã‚¸è¿½åŠ 
                            </button>
                        </div>
                        <div id="pages-container" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- Database Tab -->
            <div id="database-tab" class="tab-content hidden">
                <!-- Sub-tabs for Database -->
                <div class="card mb-6 overflow-hidden">
                    <div class="flex border-b">
                        <button class="db-subtab active flex-1 py-3 font-semibold transition" data-subtab="characters">
                            ğŸ‘¥ Characters
                        </button>
                        <button class="db-subtab flex-1 py-3 font-semibold transition" data-subtab="situations">
                            ğŸ“ Situations
                        </button>
                        <button class="db-subtab flex-1 py-3 font-semibold transition" data-subtab="actions">
                            ğŸ¬ Actions
                        </button>
                    </div>
                </div>

                <!-- Characters Sub-tab -->
                <div id="characters-subtab" class="db-subtab-content">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h2>
                            <div class="space-x-2">
                                <button id="import-json-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition">
                                    ğŸ“¥ Import JSON
                                </button>
                                <button id="export-json-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition">
                                    ğŸ“¤ Export JSON
                                </button>
                                <button id="add-character-btn" class="btn-primary text-white px-4 py-2 rounded-lg">
                                    â• æ–°è¦ç™»éŒ²
                                </button>
                            </div>
                        </div>
                        <div id="character-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                </div>

                <!-- Situations Sub-tab -->
                <div id="situations-subtab" class="db-subtab-content hidden">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå ´æ‰€ï¼‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h2>
                            <button id="add-situation-btn" class="btn-primary text-white px-4 py-2 rounded-lg">
                                â• æ–°è¦ç™»éŒ²
                            </button>
                        </div>
                        <div id="situation-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                </div>

                <!-- Actions Sub-tab -->
                <div id="actions-subtab" class="db-subtab-content hidden">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè¡Œå‹•ï¼‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h2>
                            <button id="add-action-btn" class="btn-primary text-white px-4 py-2 rounded-lg">
                                â• æ–°è¦ç™»éŒ²
                            </button>
                        </div>
                        <div id="action-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content hidden">
                <div class="card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">å“è³ªãƒ—ãƒªã‚»ãƒƒãƒˆè¨­å®š</h2>

                    <div class="space-y-6">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">é«˜ç”»è³ªåŒ–ã‚¿ã‚° (Positive)</label>
                            <textarea id="positive-preset" rows="4"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="masterpiece, best quality, ultra detailed..."></textarea>
                        </div>

                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">ãƒã‚¬ãƒ†ã‚£ãƒ–ã‚¿ã‚° (Negative)</label>
                            <textarea id="negative-preset" rows="4"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="low quality, blurry, bad anatomy..."></textarea>
                        </div>

                        <button id="save-presets-btn" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold">
                            ğŸ’¾ ä¿å­˜
                        </button>
                    </div>
                </div>

                <!-- Style Management (V5) -->
                <div class="card p-6 mt-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">ğŸ¨ ã‚¢ãƒ¼ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ç®¡ç†</h2>
                        <button id="add-style-btn" class="btn-primary text-white px-4 py-2 rounded-lg">
                            â• ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 
                        </button>
                    </div>

                    <div id="style-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <!-- Props Management (V6) -->
                <div class="card p-6 mt-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">ğŸ å°ç‰©ç®¡ç† (Props)</h2>
                        <button id="add-prop-btn" class="btn-primary text-white px-4 py-2 rounded-lg">
                            â• å°ç‰©è¿½åŠ 
                        </button>
                    </div>

                    <div id="props-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
            </div>

            <!-- Closet Tab (V9) -->
            <div id="closet-tab" class="tab-content hidden">
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">ğŸ‘— ã‚³ã‚¹ãƒãƒ¥ãƒ¼ãƒ ç®¡ç† (Costume Closet)</h2>
                        <button id="add-costume-btn" class="btn-primary text-white px-4 py-2 rounded-lg">
                            â• ã‚³ã‚¹ãƒãƒ¥ãƒ¼ãƒ è¿½åŠ 
                        </button>
                    </div>

                    <div id="costume-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="text-center text-gray-400 col-span-full py-8">
                            ã‚³ã‚¹ãƒãƒ¥ãƒ¼ãƒ ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab (V9) -->
            <div id="history-tab" class="tab-content hidden">
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">ğŸ“œ ç”Ÿæˆå±¥æ­´ (History)</h2>
                        <button id="clear-history-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                            ğŸ—‘ï¸ å…¨å‰Šé™¤
                        </button>
                    </div>

                    <div class="mb-4 flex space-x-4">
                        <button id="show-all-history" class="px-4 py-2 border-2 border-blue-500 bg-blue-500 text-white rounded-lg font-semibold transition">
                            ã™ã¹ã¦
                        </button>
                        <button id="show-favorites" class="px-4 py-2 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-semibold hover:border-blue-500 transition">
                            â˜…ãŠæ°—ã«å…¥ã‚Š
                        </button>
                    </div>

                    <div id="history-list" class="space-y-3 max-h-[600px] overflow-y-auto scrollbar-thin">
                        <div class="text-center text-gray-400 py-8">
                            ç”Ÿæˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation (V9) -->
    <nav class="bottom-nav">
        <div class="flex">
            <button class="bottom-nav-item active" data-tab="generator">
                <span class="icon">ğŸ </span>
                <span>Home</span>
            </button>
            <button class="bottom-nav-item" data-tab="closet">
                <span class="icon">ğŸ‘—</span>
                <span>Closet</span>
            </button>
            <button class="bottom-nav-item" data-tab="database">
                <span class="icon">ğŸ‘¥</span>
                <span>Chara</span>
            </button>
            <button class="bottom-nav-item" data-tab="history">
                <span class="icon">ğŸ“œ</span>
                <span>History</span>
            </button>
            <button class="bottom-nav-item" data-tab="settings">
                <span class="icon">âš™</span>
                <span>Settings</span>
            </button>
        </div>
    </nav>

    <!-- Style Modal (V5) -->
    <div id="style-modal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800" id="style-modal-title">ã‚¹ã‚¿ã‚¤ãƒ«ç™»éŒ²</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
            </div>

            <form id="style-form" class="space-y-4">
                <input type="hidden" id="style-id">

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">ã‚¹ã‚¿ã‚¤ãƒ«å (Name)</label>
                    <input type="text" id="style-name" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ä¾‹ï¼šã‚¢ãƒ‹ãƒ¡é¢¨ã€æ²¹çµµèª¿">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ (Prompt)</label>
                    <textarea id="style-prompt" rows="4" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ä¾‹ï¼šanime style, vibrant colors, cel shading"></textarea>
                </div>

                <button type="submit" class="btn-primary w-full text-white px-6 py-3 rounded-lg font-semibold">
                    ğŸ’¾ ä¿å­˜
                </button>
            </form>
        </div>
    </div>

    <!-- Props Modal (V6) -->
    <div id="props-modal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800" id="props-modal-title">å°ç‰©ç™»éŒ²</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
            </div>

            <form id="props-form" class="space-y-4">
                <input type="hidden" id="prop-id">

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">å°ç‰©å (Name)</label>
                    <input type="text" id="prop-name" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ä¾‹ï¼šå‰£ã€æœ¬ã€èŠ±æŸ">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ (Prompt)</label>
                    <textarea id="prop-prompt" rows="4" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ä¾‹ï¼šsword, steel blade, ornate handle"></textarea>
                </div>

                <button type="submit" class="btn-primary w-full text-white px-6 py-3 rounded-lg font-semibold">
                    ğŸ’¾ ä¿å­˜
                </button>
            </form>
        </div>
    </div>

    <!-- Character Edit Modal (V4 Builder) -->
    <div id="character-modal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto scrollbar-thin">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800" id="modal-title">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»ãƒ“ãƒ«ãƒ€ãƒ¼</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
            </div>

            <form id="character-form" class="space-y-6">
                <input type="hidden" id="character-id">

                <!-- Basic Info Section -->
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                        <span class="text-2xl mr-2">ğŸ“</span> åŸºæœ¬æƒ…å ±
                    </h4>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">åå‰ (Name)</label>
                            <input type="text" id="character-name" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="ä¾‹ï¼šã‚«ãƒŸãƒ«">
                        </div>

                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">ç¨®æ— (Species)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="species-jp"
                                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="æ—¥æœ¬èª: å¤©ä½¿">
                                <input type="text" id="species-en"
                                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="English: angel">
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="block text-gray-700 font-semibold mb-2">æ€§åˆ¥ (Gender)</label>
                        <div class="flex gap-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="gender" value="male" class="mr-2">
                                <span>ğŸ”µ ç”·æ€§ (Male)</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="gender" value="female" class="mr-2">
                                <span>ğŸ”´ å¥³æ€§ (Female)</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="gender" value="androgynous" class="mr-2" checked>
                                <span>âšª ä¸­æ€§çš„ (Androgynous)</span>
                            </label>
                        </div>
                    </div>

                    <!-- V8: Physical Attributes -->
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">è¦‹ãŸç›®å¹´é½¢ (Apparent Age)</label>
                            <input type="text" id="character-age"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                placeholder="ä¾‹ï¼š16æ­³ãã‚‰ã„ã€20ä»£å‰åŠã€child">
                        </div>

                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">èº«é•· (Height)</label>
                            <input type="text" id="character-height"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                placeholder="ä¾‹ï¼š158cmã€tallã€short">
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="block text-gray-700 font-semibold mb-2">éª¨æ ¼ãƒ»ä½“å‹ (Body Type)</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <label class="flex items-center p-2 border rounded-lg cursor-pointer hover:bg-blue-50">
                                <input type="radio" name="body-type" value="slender, thin" class="mr-2">
                                <span class="text-sm">ğŸª¶ ç·šãŒç´°ã„ (Slender)</span>
                            </label>
                            <label class="flex items-center p-2 border rounded-lg cursor-pointer hover:bg-blue-50">
                                <input type="radio" name="body-type" value="chubby, plump" class="mr-2">
                                <span class="text-sm">ğŸ° ã½ã£ã¡ã‚ƒã‚Š (Chubby)</span>
                            </label>
                            <label class="flex items-center p-2 border rounded-lg cursor-pointer hover:bg-blue-50">
                                <input type="radio" name="body-type" value="skinny, very thin" class="mr-2">
                                <span class="text-sm">ğŸ¦´ ã‚¬ãƒªã‚¬ãƒª (Skinny)</span>
                            </label>
                            <label class="flex items-center p-2 border rounded-lg cursor-pointer hover:bg-blue-50">
                                <input type="radio" name="body-type" value="overweight, fat" class="mr-2">
                                <span class="text-sm">ğŸ» ãŠãƒ‡ãƒ– (Overweight)</span>
                            </label>
                            <label class="flex items-center p-2 border rounded-lg cursor-pointer hover:bg-blue-50">
                                <input type="radio" name="body-type" value="muscular, athletic" class="mr-2">
                                <span class="text-sm">ğŸ’ª ç­‹è‚‰è³ª (Muscular)</span>
                            </label>
                            <label class="flex items-center p-2 border rounded-lg cursor-pointer hover:bg-blue-50">
                                <input type="radio" name="body-type" value="" class="mr-2" checked>
                                <span class="text-sm">âœï¸ ã‚«ã‚¹ã‚¿ãƒ  / æŒ‡å®šãªã—</span>
                            </label>
                        </div>
                        <input type="text" id="custom-body-type"
                            class="w-full px-4 py-2 mt-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            placeholder="ã‚«ã‚¹ã‚¿ãƒ ä½“å‹ã‚¿ã‚° (ä¾‹: petite, curvy, etc.)">
                    </div>
                </div>

                <!-- Appearance Parts Section -->
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                        <span class="text-2xl mr-2">âœ¨</span> å¤–è¦‹ãƒ‘ãƒ¼ãƒ„
                    </h4>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-600 mb-1">é«ªå‹ (Hair Style)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="hair-jp"
                                    class="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                    placeholder="ãƒ­ãƒ³ã‚°ãƒ˜ã‚¢">
                                <input type="text" id="hair-en"
                                    class="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                    placeholder="long hair">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-600 mb-1">é«ªè‰² (Hair Color)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="haircolor-jp"
                                    class="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                    placeholder="è–„èŒ¶è‰²">
                                <input type="text" id="haircolor-en"
                                    class="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                    placeholder="light brown">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-600 mb-1">ç›®ã®è‰² (Eye Color)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="eyes-jp"
                                    class="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                    placeholder="é’ã„ç›®">
                                <input type="text" id="eyes-en"
                                    class="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                    placeholder="blue eyes">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-600 mb-1">æœè£… (Clothes)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="clothes-jp"
                                    class="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                    placeholder="è»æœ">
                                <input type="text" id="clothes-en"
                                    class="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                    placeholder="military uniform">
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-gray-600 mb-1">ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ (Accessories)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="accessories-jp"
                                    class="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                    placeholder="éµã®ãƒãƒƒã‚¯ãƒ¬ã‚¹">
                                <input type="text" id="accessories-en"
                                    class="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                    placeholder="key necklace">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reference Images -->
                <div class="bg-green-50 p-4 rounded-lg">
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                        <span class="text-2xl mr-2">ğŸ–¼ï¸</span> å‚è€ƒç”»åƒ
                    </h4>
                    <input type="file" id="character-images" multiple accept="image/*"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <div id="image-preview-container" class="grid grid-cols-4 gap-2 mt-3"></div>
                </div>

                <!-- Action Buttons -->
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="btn-primary flex-1 text-white px-6 py-3 rounded-lg font-semibold">
                        ğŸ’¾ ä¿å­˜
                    </button>
                    <button type="button" class="close-modal bg-gray-300 hover:bg-gray-400 flex-1 text-gray-700 px-6 py-3 rounded-lg font-semibold transition">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div id="image-viewer-modal" class="modal">
        <div class="relative max-w-4xl mx-4">
            <button class="close-modal absolute top-4 right-4 bg-white rounded-full w-10 h-10 flex items-center justify-center text-2xl hover:bg-gray-100">
                âœ•
            </button>
            <img id="viewer-image" src="" alt="" class="max-w-full max-h-[90vh] rounded-lg">
        </div>
    </div>

    <!-- Situation Edit Modal -->
    <div id="situation-modal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-xl w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800" id="situation-modal-title">ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ç™»éŒ²</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
            </div>

            <form id="situation-form" class="space-y-4">
                <input type="hidden" id="situation-id">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">åå‰ï¼ˆãƒ©ãƒ™ãƒ«ï¼‰</label>
                    <input type="text" id="situation-name" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ä¾‹ï¼šç§ã®éƒ¨å±‹">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">ã‚¿ã‚°ï¼ˆPromptsï¼‰</label>
                    <textarea id="situation-tags" rows="3" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="bedroom, indoor, white bed, curtain"></textarea>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="btn-primary flex-1 text-white px-6 py-3 rounded-lg font-semibold">
                        ğŸ’¾ ä¿å­˜
                    </button>
                    <button type="button" class="close-modal bg-gray-300 hover:bg-gray-400 flex-1 text-gray-700 px-6 py-3 rounded-lg font-semibold transition">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Action Edit Modal -->
    <div id="action-modal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-xl w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800" id="action-modal-title">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç™»éŒ²</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
            </div>

            <form id="action-form" class="space-y-4">
                <input type="hidden" id="action-id">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">åå‰ï¼ˆæ—¥æœ¬èªãƒ©ãƒ™ãƒ«ï¼‰</label>
                    <input type="text" id="action-name" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ä¾‹ï¼šç¥ˆã£ã¦ã„ã‚‹">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">ã‚¿ã‚°ï¼ˆè‹±èªPromptsï¼‰</label>
                    <textarea id="action-tags" rows="3" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="praying, clasped hands, closed eyes"></textarea>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="btn-primary flex-1 text-white px-6 py-3 rounded-lg font-semibold">
                        ğŸ’¾ ä¿å­˜
                    </button>
                    <button type="button" class="close-modal bg-gray-300 hover:bg-gray-400 flex-1 text-gray-700 px-6 py-3 rounded-lg font-semibold transition">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Edit Modal (V3) -->
    <div id="project-modal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto scrollbar-thin">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800" id="project-modal-title">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
            </div>

            <form id="project-form" class="space-y-4">
                <input type="hidden" id="project-id">

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="project-title" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ä¾‹ï¼šé­”æ³•å°‘å¥³ã®æ—¥å¸¸">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">ãƒ—ãƒ­ãƒƒãƒˆï¼ˆã‚ã‚‰ã™ã˜ï¼‰</label>
                    <textarea id="project-plot" rows="6"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ç‰©èªã®ã‚ã‚‰ã™ã˜ã‚„ãƒ¡ãƒ¢ã‚’è¨˜å…¥..."></textarea>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="btn-primary flex-1 text-white px-6 py-3 rounded-lg font-semibold">
                        ğŸ’¾ ä¿å­˜
                    </button>
                    <button type="button" class="close-modal bg-gray-300 hover:bg-gray-400 flex-1 text-gray-700 px-6 py-3 rounded-lg font-semibold transition">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Costume Modal (V9) -->
    <div id="costume-modal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto scrollbar-thin">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800" id="costume-modal-title">ã‚³ã‚¹ãƒãƒ¥ãƒ¼ãƒ ç™»éŒ²</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
            </div>

            <form id="costume-form" class="space-y-4">
                <input type="hidden" id="costume-id">

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">è¡£è£…å (Name)</label>
                    <input type="text" id="costume-name" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ä¾‹ï¼šå­¦æ ¡åˆ¶æœã€æ°´ç€ã€ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ‰ãƒ¬ã‚¹">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">å…¨èº«/ã‚»ãƒƒãƒˆæœ (Full Set Outfit)</label>
                    <textarea id="costume-fullset" rows="3"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ä¾‹ï¼šschool uniform, white blouse, plaid skirt, red ribbon"></textarea>
                    <p class="text-sm text-gray-500 mt-1">â€»ã‚»ãƒƒãƒˆæœã®å ´åˆã¯ã“ã¡ã‚‰ã®ã¿è¨˜å…¥ã€‚ä¸Šä¸‹åˆ¥ã®å ´åˆã¯ä¸‹ã®é …ç›®ã‚’ä½¿ç”¨ã€‚</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ãƒˆãƒƒãƒ—ã‚¹ (Top)</label>
                        <textarea id="costume-top" rows="2"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="ä¾‹ï¼šwhite t-shirt, denim jacket"></textarea>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ãƒœãƒˆãƒ ã‚¹ (Bottom)</label>
                        <textarea id="costume-bottom" rows="2"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="ä¾‹ï¼šblack pants, leather boots"></textarea>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼1 (Accessory A)</label>
                        <input type="text" id="costume-acc-a"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="ä¾‹ï¼šnecklace, earrings">
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼2 (Accessory B)</label>
                        <input type="text" id="costume-acc-b"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="ä¾‹ï¼šhat, glasses">
                    </div>
                </div>

                <button type="submit" class="btn-primary w-full text-white px-6 py-3 rounded-lg font-semibold">
                    ğŸ’¾ ä¿å­˜
                </button>
            </form>
        </div>
    </div>

    <!-- Firebase Sync Modal (V9) -->
    <div id="firebase-sync-modal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800">â˜ ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
            </div>

            <div id="firebase-login-section">
                <p class="text-gray-600 mb-4">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ãƒ»å¾©å…ƒã§ãã¾ã™ã€‚</p>
                <button id="firebase-login-btn" class="btn-primary w-full text-white px-6 py-3 rounded-lg font-semibold mb-3">
                    ğŸ” Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </div>

            <div id="firebase-sync-section" class="hidden">
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-2">ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <span id="firebase-user-email" class="font-semibold"></span></p>
                    <button id="firebase-logout-btn" class="text-sm text-red-500 hover:text-red-700">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>

                <div class="space-y-3">
                    <button id="firebase-upload-btn" class="btn-primary w-full text-white px-6 py-3 rounded-lg font-semibold">
                        â¬†ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </button>
                    <button id="firebase-download-btn" class="bg-green-500 hover:bg-green-600 w-full text-white px-6 py-3 rounded-lg font-semibold transition">
                        â¬‡ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                </div>

                <p class="text-xs text-gray-500 mt-4">â€»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚</p>
            </div>
        </div>
    </div>

    <script>
        // ===== IndexedDB Setup =====
        const DB_NAME = 'NanobananaLinkerDB';
        const DB_VERSION = 7; // V9: Added Costumes and History stores
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    // Characters Store
                    if (!db.objectStoreNames.contains('characters')) {
                        const characterStore = db.createObjectStore('characters', { keyPath: 'id', autoIncrement: true });
                        characterStore.createIndex('name', 'name', { unique: false });
                    }

                    // Situations Store (V2)
                    if (!db.objectStoreNames.contains('situations')) {
                        const situationStore = db.createObjectStore('situations', { keyPath: 'id', autoIncrement: true });
                        situationStore.createIndex('name', 'name', { unique: false });
                    }

                    // Actions Store (V2)
                    if (!db.objectStoreNames.contains('actions')) {
                        const actionStore = db.createObjectStore('actions', { keyPath: 'id', autoIncrement: true });
                        actionStore.createIndex('name', 'name', { unique: false });
                    }

                    // Projects Store (V3)
                    if (!db.objectStoreNames.contains('projects')) {
                        const projectStore = db.createObjectStore('projects', { keyPath: 'id', autoIncrement: true });
                        projectStore.createIndex('title', 'title', { unique: false });
                        projectStore.createIndex('createdAt', 'createdAt', { unique: false });
                    }

                    // Pages Store (V3)
                    if (!db.objectStoreNames.contains('pages')) {
                        const pageStore = db.createObjectStore('pages', { keyPath: 'id', autoIncrement: true });
                        pageStore.createIndex('projectId', 'projectId', { unique: false });
                        pageStore.createIndex('order', 'order', { unique: false });
                    }

                    // Styles Store (V5)
                    if (!db.objectStoreNames.contains('styles')) {
                        const styleStore = db.createObjectStore('styles', { keyPath: 'id', autoIncrement: true });
                        styleStore.createIndex('name', 'name', { unique: false });
                    }

                    // Props Store (V6)
                    if (!db.objectStoreNames.contains('props')) {
                        const propStore = db.createObjectStore('props', { keyPath: 'id', autoIncrement: true });
                        propStore.createIndex('name', 'name', { unique: false });
                    }

                    // Costumes Store (V9)
                    if (!db.objectStoreNames.contains('costumes')) {
                        const costumeStore = db.createObjectStore('costumes', { keyPath: 'id', autoIncrement: true });
                        costumeStore.createIndex('name', 'name', { unique: false });
                    }

                    // History Store (V9)
                    if (!db.objectStoreNames.contains('history')) {
                        const historyStore = db.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
                        historyStore.createIndex('timestamp', 'timestamp', { unique: false });
                        historyStore.createIndex('favorite', 'favorite', { unique: false });
                    }

                    // Settings Store
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
            });
        }

        // ===== Database Operations =====
        function addCharacter(character) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['characters'], 'readwrite');
                const store = transaction.objectStore('characters');
                const request = store.add(character);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updateCharacter(character) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['characters'], 'readwrite');
                const store = transaction.objectStore('characters');
                const request = store.put(character);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteCharacter(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['characters'], 'readwrite');
                const store = transaction.objectStore('characters');
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getAllCharacters() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['characters'], 'readonly');
                const store = transaction.objectStore('characters');
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // ===== Situation Operations (V2) =====
        function addSituation(situation) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['situations'], 'readwrite');
                const store = transaction.objectStore('situations');
                const request = store.add(situation);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updateSituation(situation) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['situations'], 'readwrite');
                const store = transaction.objectStore('situations');
                const request = store.put(situation);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteSituation(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['situations'], 'readwrite');
                const store = transaction.objectStore('situations');
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getAllSituations() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['situations'], 'readonly');
                const store = transaction.objectStore('situations');
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // ===== Action Operations (V2) =====
        function addAction(action) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['actions'], 'readwrite');
                const store = transaction.objectStore('actions');
                const request = store.add(action);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updateAction(action) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['actions'], 'readwrite');
                const store = transaction.objectStore('actions');
                const request = store.put(action);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteAction(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['actions'], 'readwrite');
                const store = transaction.objectStore('actions');
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getAllActions() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['actions'], 'readonly');
                const store = transaction.objectStore('actions');
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // ===== Style Operations (V5) =====
        function addStyle(style) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['styles'], 'readwrite');
                const store = transaction.objectStore('styles');
                const request = store.add(style);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updateStyle(style) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['styles'], 'readwrite');
                const store = transaction.objectStore('styles');
                const request = store.put(style);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteStyle(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['styles'], 'readwrite');
                const store = transaction.objectStore('styles');
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getAllStyles() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['styles'], 'readonly');
                const store = transaction.objectStore('styles');
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // ===== Props Operations (V6) =====
        function addProp(prop) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['props'], 'readwrite');
                const store = transaction.objectStore('props');
                const request = store.add(prop);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updateProp(prop) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['props'], 'readwrite');
                const store = transaction.objectStore('props');
                const request = store.put(prop);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteProp(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['props'], 'readwrite');
                const store = transaction.objectStore('props');
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getAllProps() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['props'], 'readonly');
                const store = transaction.objectStore('props');
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // ===== Costume Operations (V9) =====
        function addCostume(costume) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['costumes'], 'readwrite');
                const store = transaction.objectStore('costumes');
                const request = store.add(costume);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updateCostume(costume) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['costumes'], 'readwrite');
                const store = transaction.objectStore('costumes');
                const request = store.put(costume);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteCostume(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['costumes'], 'readwrite');
                const store = transaction.objectStore('costumes');
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getAllCostumes() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['costumes'], 'readonly');
                const store = transaction.objectStore('costumes');
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // ===== History Operations (V9) =====
        function addHistory(historyItem) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['history'], 'readwrite');
                const store = transaction.objectStore('history');
                historyItem.timestamp = Date.now();
                historyItem.favorite = historyItem.favorite || false;
                const request = store.add(historyItem);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updateHistory(historyItem) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['history'], 'readwrite');
                const store = transaction.objectStore('history');
                const request = store.put(historyItem);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteHistory(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['history'], 'readwrite');
                const store = transaction.objectStore('history');
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getAllHistory() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['history'], 'readonly');
                const store = transaction.objectStore('history');
                const index = store.index('timestamp');
                const request = index.openCursor(null, 'prev'); // æ–°ã—ã„é †
                const results = [];

                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        results.push(cursor.value);
                        cursor.continue();
                    } else {
                        resolve(results);
                    }
                };
                request.onerror = () => reject(request.error);
            });
        }

        // ===== Project Operations (V3) =====
        function addProject(project) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['projects'], 'readwrite');
                const store = transaction.objectStore('projects');
                project.createdAt = Date.now();
                const request = store.add(project);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updateProject(project) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['projects'], 'readwrite');
                const store = transaction.objectStore('projects');
                const request = store.put(project);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteProject(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['projects'], 'readwrite');
                const store = transaction.objectStore('projects');
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getAllProjects() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['projects'], 'readonly');
                const store = transaction.objectStore('projects');
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getProject(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['projects'], 'readonly');
                const store = transaction.objectStore('projects');
                const request = store.get(id);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // ===== Page Operations (V3) =====
        function addPage(page) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['pages'], 'readwrite');
                const store = transaction.objectStore('pages');
                const request = store.add(page);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updatePage(page) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['pages'], 'readwrite');
                const store = transaction.objectStore('pages');
                const request = store.put(page);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deletePage(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['pages'], 'readwrite');
                const store = transaction.objectStore('pages');
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getPagesByProject(projectId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['pages'], 'readonly');
                const store = transaction.objectStore('pages');
                const index = store.index('projectId');
                const request = index.getAll(projectId);

                request.onsuccess = () => {
                    const pages = request.result;
                    // Sort by order
                    pages.sort((a, b) => a.order - b.order);
                    resolve(pages);
                };
                request.onerror = () => reject(request.error);
            });
        }

        function saveSetting(key, value) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['settings'], 'readwrite');
                const store = transaction.objectStore('settings');
                const request = store.put({ key, value });

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getSetting(key, defaultValue = '') {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                const request = store.get(key);

                request.onsuccess = () => {
                    resolve(request.result ? request.result.value : defaultValue);
                };
                request.onerror = () => reject(request.error);
            });
        }

        // ===== UI State (V2) =====
        let currentTab = 'generator';
        let currentMode = 'solo'; // solo, duo, comic
        let currentDBSubtab = 'characters';
        let selectedCharacters = []; // Array of character objects
        let selectedSituation = null;
        let selectedAction = null;
        let selectedImages = [];
        let editingCharacterId = null;
        let editingSituationId = null;
        let editingActionId = null;

        // V8: Per-character advanced settings
        // Structure: { characterId: { composition, gaze, states: [], ageModifier } }
        let perCharacterSettings = {};

        // ===== UI State (V3 Story Mode) =====
        let currentProjectId = null;
        let currentProject = null;
        let editingProjectId = null;
        let openPageId = null; // Currently open accordion page

        // ===== UI State (V4) =====
        let currentOutputFormat = 'standard'; // standard, simple-jp, natural
        let strictSourceMode = false;

        // ===== Tab Navigation (V2, V9: Updated for Bottom Nav) =====
        function switchTab(tabName) {
            currentTab = tabName;

            // Update tab buttons (V9: Support both old and new nav)
            document.querySelectorAll('.tab-button, .bottom-nav-item').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');

            // Load data for specific tabs
            if (tabName === 'generator') {
                renderGeneratorHub();
            } else if (tabName === 'story') {
                loadProjectList();
            } else if (tabName === 'database') {
                loadCharacterList();
                loadSituationList();
                loadActionList();
            } else if (tabName === 'closet') {
                // V9: Load costume list
                loadCostumeList();
            } else if (tabName === 'history') {
                // V9: Load history list
                loadHistoryList();
            } else if (tabName === 'settings') {
                loadSettings();
            }
        }

        function switchDBSubtab(subtab) {
            currentDBSubtab = subtab;

            // Update subtab buttons
            document.querySelectorAll('.db-subtab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.subtab === subtab);
            });

            // Update subtab content
            document.querySelectorAll('.db-subtab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${subtab}-subtab`).classList.remove('hidden');
        }

        // ===== Mode Switching (V2) =====
        function switchMode(mode) {
            currentMode = mode;

            // Update mode buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            // Show/hide duo options
            if (mode === 'duo') {
                document.getElementById('duo-options').classList.remove('hidden');
            } else {
                document.getElementById('duo-options').classList.add('hidden');
            }

            // Update UI based on mode
            if (mode === 'solo') {
                // Solo mode: clear multiple selections, keep only first
                if (selectedCharacters.length > 1) {
                    selectedCharacters = [selectedCharacters[0]];
                }
            }

            renderCharacterSelector();
            updatePromptPreview();
        }

        // ===== Character Selection (V2) =====
        async function renderCharacterSelector() {
            const container = document.getElementById('character-selector');
            const characters = await getAllCharacters();

            if (characters.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 col-span-full py-8">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>';
                return;
            }

            container.innerHTML = characters.map(char => {
                const isSelected = selectedCharacters.some(c => c.id === char.id);
                const thumbnail = char.images && char.images[0] ? char.images[0] : '';

                return `
                    <div class="character-card card p-2 text-center ${isSelected ? 'selected' : ''}" data-id="${char.id}">
                        ${thumbnail ? `<img src="${thumbnail}" alt="${char.name}" class="w-full h-20 object-cover rounded mb-2">` : '<div class="w-full h-20 bg-gray-200 rounded mb-2 flex items-center justify-center text-3xl">ğŸ‘¤</div>'}
                        <div class="text-sm font-semibold text-gray-800 truncate">${char.name}</div>
                    </div>
                `;
            }).join('');

            // Update reference images
            updateReferenceImages();
        }

        async function toggleCharacterSelection(characterId) {
            const characters = await getAllCharacters();
            const character = characters.find(c => c.id === parseInt(characterId));

            if (!character) return;

            const index = selectedCharacters.findIndex(c => c.id === character.id);

            if (index >= 0) {
                // Deselect
                selectedCharacters.splice(index, 1);
                // V8: Remove per-character settings
                delete perCharacterSettings[character.id];
            } else {
                // Select
                if (currentMode === 'solo') {
                    // Solo mode: replace selection
                    selectedCharacters = [character];
                    // V8: Clear other settings
                    perCharacterSettings = {};
                } else {
                    // Duo/Comic mode: add selection
                    selectedCharacters.push(character);
                }
                // V8: Initialize settings for new character
                if (!perCharacterSettings[character.id]) {
                    perCharacterSettings[character.id] = {
                        composition: '',
                        gaze: '',
                        states: [],
                        ageModifier: ''
                    };
                }
            }

            renderCharacterSelector();
            renderPerCharacterAdvancedSettings(); // V8
            updatePromptPreview();
        }

        function updateReferenceImages() {
            const container = document.getElementById('reference-images');
            const allImages = [];

            selectedCharacters.forEach(char => {
                if (char && char.images) {
                    allImages.push(...char.images.map(img => ({ char: char.name, data: img })));
                }
            });

            if (allImages.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 col-span-3 py-8 text-sm">ã‚­ãƒ£ãƒ©ã‚’é¸æŠã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™</div>';
                return;
            }

            container.innerHTML = allImages.slice(0, 10).map((img, index) => `
                <div class="relative group">
                    <img src="${img.data}" alt="${img.char}" class="image-preview" data-index="${index}">
                    <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs p-1 text-center opacity-0 group-hover:opacity-100 transition">
                        ${img.char}
                    </div>
                </div>
            `).join('');

            selectedImages = allImages;
        }

        // V8: Render per-character advanced settings
        function renderPerCharacterAdvancedSettings() {
            const container = document.getElementById('per-character-advanced-settings');

            if (selectedCharacters.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = selectedCharacters.map(char => {
                const settings = perCharacterSettings[char.id] || { composition: '', gaze: '', states: [], ageModifier: '' };

                return `
                    <div class="accordion">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            <span>âš™ï¸ ${char.name} - è©³ç´°è¨­å®š</span>
                            <span class="icon">â–¼</span>
                        </div>
                        <div class="accordion-content collapsed">
                            <div class="space-y-4">
                                <!-- Composition -->
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2 text-sm">ğŸ“ æ§‹å›³ (Composition)</label>
                                    <select class="char-composition w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" data-char-id="${char.id}">
                                        <option value="">æŒ‡å®šãªã—</option>
                                        <option value="face only" ${settings.composition === 'face only' ? 'selected' : ''}>ğŸ˜¶ é¡”ã ã‘</option>
                                        <option value="face focus, close-up" ${settings.composition === 'face focus, close-up' ? 'selected' : ''}>ğŸ˜€ é¡”ã‚¢ãƒƒãƒ—</option>
                                        <option value="upper body, bust shot" ${settings.composition === 'upper body, bust shot' ? 'selected' : ''}>ğŸ‘” ãƒã‚¹ãƒˆã‚¢ãƒƒãƒ—</option>
                                        <option value="upper body" ${settings.composition === 'upper body' ? 'selected' : ''}>ğŸ™‹ ä¸ŠåŠèº«</option>
                                        <option value="cowboy shot" ${settings.composition === 'cowboy shot' ? 'selected' : ''}>ğŸ¤  å¤ªã‚‚ã‚‚ã‹ã‚‰ä¸Š</option>
                                        <option value="full body" ${settings.composition === 'full body' ? 'selected' : ''}>ğŸ§ å…¨èº«</option>
                                    </select>
                                </div>

                                <!-- Gaze -->
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2 text-sm">ğŸ‘ï¸ è¦–ç·š (Gaze)</label>
                                    <select class="char-gaze w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" data-char-id="${char.id}">
                                        <option value="">æŒ‡å®šãªã—</option>
                                        <option value="looking at viewer" ${settings.gaze === 'looking at viewer' ? 'selected' : ''}>ğŸ“· ã‚«ãƒ¡ãƒ©ç›®ç·š</option>
                                        <option value="looking up" ${settings.gaze === 'looking up' ? 'selected' : ''}>ğŸ”º ä¸Šç›®é£ã„</option>
                                        <option value="looking down" ${settings.gaze === 'looking down' ? 'selected' : ''}>ğŸ”» è¦‹ä¸‹ã‚ã™</option>
                                        <option value="looking away, averted eyes" ${settings.gaze === 'looking away, averted eyes' ? 'selected' : ''}>â†”ï¸ ç›®ã‚’é€¸ã‚‰ã™</option>
                                        <option value="looking back" ${settings.gaze === 'looking back' ? 'selected' : ''}>ğŸ”™ å¾Œã‚ã‚’è¦‹ã‚‹</option>
                                    </select>
                                </div>

                                <!-- States -->
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2 text-sm">ğŸ’« çŠ¶æ…‹ (State)</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="flex items-center space-x-2 p-2 border rounded-lg cursor-pointer hover:bg-blue-50 text-sm">
                                            <input type="checkbox" class="char-state w-4 h-4" data-char-id="${char.id}" data-state="heavy breathing, panting" ${settings.states.includes('heavy breathing, panting') ? 'checked' : ''}>
                                            <span>ğŸ˜®â€ğŸ’¨ æ¯è’ã„</span>
                                        </label>
                                        <label class="flex items-center space-x-2 p-2 border rounded-lg cursor-pointer hover:bg-blue-50 text-sm">
                                            <input type="checkbox" class="char-state w-4 h-4" data-char-id="${char.id}" data-state="blush, embarrassed" ${settings.states.includes('blush, embarrassed') ? 'checked' : ''}>
                                            <span>ğŸ˜Š èµ¤é¢</span>
                                        </label>
                                        <label class="flex items-center space-x-2 p-2 border rounded-lg cursor-pointer hover:bg-blue-50 text-sm">
                                            <input type="checkbox" class="char-state w-4 h-4" data-char-id="${char.id}" data-state="teary eyes, watery eyes" ${settings.states.includes('teary eyes, watery eyes') ? 'checked' : ''}>
                                            <span>ğŸ¥º æ¶™ç›®</span>
                                        </label>
                                        <label class="flex items-center space-x-2 p-2 border rounded-lg cursor-pointer hover:bg-blue-50 text-sm">
                                            <input type="checkbox" class="char-state w-4 h-4" data-char-id="${char.id}" data-state="fang, yaeba" ${settings.states.includes('fang, yaeba') ? 'checked' : ''}>
                                            <span>ğŸ˜ å…«é‡æ­¯</span>
                                        </label>
                                        <label class="flex items-center space-x-2 p-2 border rounded-lg cursor-pointer hover:bg-blue-50 text-sm">
                                            <input type="checkbox" class="char-state w-4 h-4" data-char-id="${char.id}" data-state="half-closed eyes, jitome" ${settings.states.includes('half-closed eyes, jitome') ? 'checked' : ''}>
                                            <span>ğŸ˜‘ ã‚¸ãƒˆç›®</span>
                                        </label>
                                        <label class="flex items-center space-x-2 p-2 border rounded-lg cursor-pointer hover:bg-blue-50 text-sm">
                                            <input type="checkbox" class="char-state w-4 h-4" data-char-id="${char.id}" data-state="empty eyes, highlight off" ${settings.states.includes('empty eyes, highlight off') ? 'checked' : ''}>
                                            <span>âš« ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚ªãƒ•</span>
                                        </label>
                                        <label class="flex items-center space-x-2 p-2 border rounded-lg cursor-pointer hover:bg-blue-50 text-sm">
                                            <input type="checkbox" class="char-state w-4 h-4" data-char-id="${char.id}" data-state="yandere" ${settings.states.includes('yandere') ? 'checked' : ''}>
                                            <span>ğŸ”ª ãƒ¤ãƒ³ãƒ‡ãƒ¬</span>
                                        </label>
                                        <label class="flex items-center space-x-2 p-2 border rounded-lg cursor-pointer hover:bg-blue-50 text-sm">
                                            <input type="checkbox" class="char-state w-4 h-4" data-char-id="${char.id}" data-state="angry, angry face" ${settings.states.includes('angry, angry face') ? 'checked' : ''}>
                                            <span>ğŸ˜  æ€’ã‚Š</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Age Modifier -->
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2 text-sm">ğŸ‘¶ å¹´é½¢ä¿®æ­£ (Age)</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center space-x-2 cursor-pointer text-sm">
                                            <input type="radio" name="age-${char.id}" class="char-age w-4 h-4" data-char-id="${char.id}" value="toddler, very young" ${settings.ageModifier === 'toddler, very young' ? 'checked' : ''}>
                                            <span>ğŸ‘¶ å¹¼å…</span>
                                        </label>
                                        <label class="flex items-center space-x-2 cursor-pointer text-sm">
                                            <input type="radio" name="age-${char.id}" class="char-age w-4 h-4" data-char-id="${char.id}" value="child, young" ${settings.ageModifier === 'child, young' ? 'checked' : ''}>
                                            <span>ğŸ§’ å°‘å¹´ãƒ»å°‘å¥³</span>
                                        </label>
                                        <label class="flex items-center space-x-2 cursor-pointer text-sm">
                                            <input type="radio" name="age-${char.id}" class="char-age w-4 h-4" data-char-id="${char.id}" value="" ${settings.ageModifier === '' ? 'checked' : ''}>
                                            <span>ğŸ§‘ é’å¹´ (Default)</span>
                                        </label>
                                        <label class="flex items-center space-x-2 cursor-pointer text-sm">
                                            <input type="radio" name="age-${char.id}" class="char-age w-4 h-4" data-char-id="${char.id}" value="middle-aged, mature" ${settings.ageModifier === 'middle-aged, mature' ? 'checked' : ''}>
                                            <span>ğŸ§“ å¹´é…</span>
                                        </label>
                                        <label class="flex items-center space-x-2 cursor-pointer text-sm">
                                            <input type="radio" name="age-${char.id}" class="char-age w-4 h-4" data-char-id="${char.id}" value="old, elderly" ${settings.ageModifier === 'old, elderly' ? 'checked' : ''}>
                                            <span>ğŸ‘´ è€äºº</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add event listeners for per-character settings
            attachPerCharacterSettingsListeners();
        }

        // V8: Attach event listeners for per-character advanced settings
        function attachPerCharacterSettingsListeners() {
            // Composition selectors
            document.querySelectorAll('.char-composition').forEach(select => {
                select.addEventListener('change', (e) => {
                    const charId = parseInt(e.target.dataset.charId);
                    if (perCharacterSettings[charId]) {
                        perCharacterSettings[charId].composition = e.target.value;
                        updatePromptPreview();
                    }
                });
            });

            // Gaze selectors
            document.querySelectorAll('.char-gaze').forEach(select => {
                select.addEventListener('change', (e) => {
                    const charId = parseInt(e.target.dataset.charId);
                    if (perCharacterSettings[charId]) {
                        perCharacterSettings[charId].gaze = e.target.value;
                        updatePromptPreview();
                    }
                });
            });

            // State checkboxes
            document.querySelectorAll('.char-state').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const charId = parseInt(e.target.dataset.charId);
                    const state = e.target.dataset.state;
                    if (perCharacterSettings[charId]) {
                        if (e.target.checked) {
                            if (!perCharacterSettings[charId].states.includes(state)) {
                                perCharacterSettings[charId].states.push(state);
                            }
                        } else {
                            perCharacterSettings[charId].states = perCharacterSettings[charId].states.filter(s => s !== state);
                        }
                        updatePromptPreview();
                    }
                });
            });

            // Age modifier radios
            document.querySelectorAll('.char-age').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const charId = parseInt(e.target.dataset.charId);
                    if (perCharacterSettings[charId]) {
                        perCharacterSettings[charId].ageModifier = e.target.value;
                        updatePromptPreview();
                    }
                });
            });
        }

        // ===== Situation Selection (V2) =====
        async function renderSituationSelector() {
            const container = document.getElementById('situation-selector');
            const situations = await getAllSituations();

            let html = '<button class="situation-btn p-3 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition' + (!selectedSituation ? ' active' : '') + '" data-id="">æŒ‡å®šãªã—</button>';

            html += situations.map(situation => `
                <button class="situation-btn p-3 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition ${selectedSituation && selectedSituation.id === situation.id ? 'active' : ''}" data-id="${situation.id}">
                    ${situation.name}
                </button>
            `).join('');

            container.innerHTML = html;
        }

        async function selectSituation(situationId) {
            if (!situationId) {
                selectedSituation = null;
            } else {
                const situations = await getAllSituations();
                selectedSituation = situations.find(s => s.id === parseInt(situationId)) || null;
            }

            renderSituationSelector();
            updatePromptPreview();
        }

        // ===== Action Selection (V2) =====
        async function renderActionSelector() {
            const container = document.getElementById('action-selector');
            const actions = await getAllActions();

            let html = '<button class="action-btn p-3 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition' + (!selectedAction ? ' active' : '') + '" data-id="">æŒ‡å®šãªã—</button>';

            html += actions.map(action => `
                <button class="action-btn p-3 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition ${selectedAction && selectedAction.id === action.id ? 'active' : ''}" data-id="${action.id}">
                    ${action.name}
                </button>
            `).join('');

            container.innerHTML = html;
        }

        async function selectAction(actionId) {
            if (!actionId) {
                selectedAction = null;
            } else {
                const actions = await getAllActions();
                selectedAction = actions.find(a => a.id === parseInt(actionId)) || null;
            }

            renderActionSelector();
            updatePromptPreview();
        }

        // ===== Generator Hub Init (V2) =====
        async function renderGeneratorHub() {
            await renderCharacterSelector();
            await renderSituationSelector();
            await renderActionSelector();
            updatePromptPreview();
        }

        // ===== Character Prompt Builder (V4) =====
        async function buildCharacterPrompt(character, format, selectedCostume = null) {
            if (!character.builder) return ''; // Fallback for old data

            const b = character.builder;
            const parts = [];

            if (format === 'standard') {
                // Standard Tags: 1boy/1girl, androgynous, angel, long hair, light brown, blue eyes...
                if (b.gender === 'male') parts.push('1boy');
                else if (b.gender === 'female') parts.push('1girl');
                else if (b.gender === 'androgynous') parts.push('1boy', 'androgynous');

                if (b.species?.en) parts.push(b.species.en);
                if (b.hair?.en) parts.push(b.hair.en);
                if (b.hairColor?.en) parts.push(b.hairColor.en + ' hair');
                if (b.eyes?.en) parts.push(b.eyes.en);

                // V9: Use costume if selected, otherwise use character's clothes
                if (selectedCostume) {
                    if (selectedCostume.fullSet) {
                        parts.push(selectedCostume.fullSet);
                    } else {
                        if (selectedCostume.top) parts.push(selectedCostume.top);
                        if (selectedCostume.bottom) parts.push(selectedCostume.bottom);
                    }
                    if (selectedCostume.accA) parts.push(selectedCostume.accA);
                    if (selectedCostume.accB) parts.push(selectedCostume.accB);
                } else {
                    if (b.clothes?.en) parts.push(b.clothes.en);
                    if (b.accessories?.en) parts.push(b.accessories.en);
                }

                return parts.filter(p => p).join(', ');

            } else if (format === 'simple-jp') {
                // Simple JP: ç”·ã®å­, ä¸­æ€§çš„, å¤©ä½¿, ãƒ­ãƒ³ã‚°ãƒ˜ã‚¢, è–„èŒ¶è‰²ã®é«ª...
                if (b.gender === 'male') parts.push('ç”·ã®å­');
                else if (b.gender === 'female') parts.push('å¥³ã®å­');
                else if (b.gender === 'androgynous') parts.push('ç”·ã®å­', 'ä¸­æ€§çš„');

                if (b.species?.jp) parts.push(b.species.jp);
                if (b.hair?.jp) parts.push(b.hair.jp);
                if (b.hairColor?.jp) parts.push(b.hairColor.jp + 'ã®é«ª');
                if (b.eyes?.jp) parts.push(b.eyes.jp);

                // V9: Use costume if selected
                if (selectedCostume) {
                    if (selectedCostume.fullSet) parts.push(selectedCostume.fullSet);
                    else {
                        if (selectedCostume.top) parts.push(selectedCostume.top);
                        if (selectedCostume.bottom) parts.push(selectedCostume.bottom);
                    }
                    if (selectedCostume.accA) parts.push(selectedCostume.accA);
                    if (selectedCostume.accB) parts.push(selectedCostume.accB);
                } else {
                    if (b.clothes?.jp) parts.push(b.clothes.jp);
                    if (b.accessories?.jp) parts.push(b.accessories.jp);
                }

                return parts.filter(p => p).join(', ');

            } else if (format === 'natural') {
                // Natural Language: An androgynous angel boy with long light brown hair and blue eyes, wearing military uniform...
                let desc = '';

                // Gender + Species
                const article = (b.gender === 'androgynous') ? 'An' : 'A';
                const genderTerm = (b.gender === 'male') ? 'boy' : (b.gender === 'female') ? 'girl' : 'person';
                const speciesTerm = b.species?.en || '';

                if (b.gender === 'androgynous' && speciesTerm) {
                    desc = `${article} ${b.gender} ${speciesTerm} ${genderTerm}`;
                } else if (speciesTerm) {
                    desc = `${article} ${speciesTerm} ${genderTerm}`;
                } else {
                    desc = `${article} ${genderTerm}`;
                }

                // Hair
                const hairParts = [];
                if (b.hair?.en) hairParts.push(b.hair.en.toLowerCase());
                if (b.hairColor?.en) hairParts.push(b.hairColor.en.toLowerCase());
                if (hairParts.length > 0) {
                    desc += ` with ${hairParts.join(' ')} hair`;
                }

                // Eyes
                if (b.eyes?.en) {
                    desc += ` and ${b.eyes.en.toLowerCase()}`;
                }

                // V9: Clothes - Use costume if selected
                if (selectedCostume) {
                    if (selectedCostume.fullSet) {
                        desc += `, wearing ${selectedCostume.fullSet.toLowerCase()}`;
                    } else {
                        const clothesParts = [];
                        if (selectedCostume.top) clothesParts.push(selectedCostume.top.toLowerCase());
                        if (selectedCostume.bottom) clothesParts.push(selectedCostume.bottom.toLowerCase());
                        if (clothesParts.length > 0) {
                            desc += `, wearing ${clothesParts.join(' and ')}`;
                        }
                    }
                    // Accessories from costume
                    const accParts = [];
                    if (selectedCostume.accA) accParts.push(selectedCostume.accA.toLowerCase());
                    if (selectedCostume.accB) accParts.push(selectedCostume.accB.toLowerCase());
                    if (accParts.length > 0) {
                        desc += ` and ${accParts.join(' and ')}`;
                    }
                } else {
                    if (b.clothes?.en) {
                        desc += `, wearing ${b.clothes.en.toLowerCase()}`;
                    }
                    if (b.accessories?.en) {
                        desc += ` and ${b.accessories.en.toLowerCase()}`;
                    }
                }

                return desc;
            }

            return '';
        }

        // ===== Prompt Generation (V4) =====
        async function generatePrompt() {
            const format = document.getElementById('output-format')?.value || 'standard';
            const strictSource = document.getElementById('strict-source-mode')?.checked || false;
            const includePositive = document.getElementById('quality-positive-toggle').checked;
            const includeNegative = document.getElementById('quality-negative-toggle').checked;

            const positivePreset = includePositive ? await getSetting('positivePreset', 'masterpiece, best quality, ultra detailed, 8k resolution') : '';
            const negativePreset = includeNegative ? await getSetting('negativePreset', 'low quality, worst quality, blurry, bad anatomy, watermark') : '';

            const customAction = document.getElementById('custom-action-input')?.value.trim();

            // Build structured sections
            const sections = [];

            // V4.1: Strict Source Mode (multiple characters)
            if (strictSource && selectedCharacters.length > 0) {
                const charNames = selectedCharacters.map(c => `ã€Œ${c.name}ã€`).join('ã¨');
                const actionText = customAction || selectedAction?.name || 'ç”»åƒ';
                const instruction = `æ·»ä»˜ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å”¯ä¸€ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚½ãƒ¼ã‚¹ã¨ã—ã¦ã€${charNames}ã®ã€Œ${actionText}ã€ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚`;
                sections.push(instruction);
            }

            // Header: Quality preset
            if (positivePreset) {
                sections.push(positivePreset);
            }

            // V9: Get selected costume
            const costumeId = document.getElementById('costume-selector')?.value;
            let selectedCostume = null;
            if (costumeId) {
                const costumes = await getAllCostumes();
                selectedCostume = costumes.find(c => c.id === parseInt(costumeId));
            }

            // Character sections with V8 per-character advanced settings
            if (selectedCharacters.length > 0) {
                for (const char of selectedCharacters) {
                    const charTags = await buildCharacterPrompt(char, format, selectedCostume);

                    // V8: Add per-character advanced settings
                    const advancedParts = [];
                    const settings = perCharacterSettings[char.id];
                    if (settings) {
                        if (settings.composition) advancedParts.push(settings.composition);
                        if (settings.gaze) advancedParts.push(settings.gaze);
                        if (settings.states && settings.states.length > 0) {
                            advancedParts.push(...settings.states);
                        }
                        if (settings.ageModifier) advancedParts.push(settings.ageModifier);
                    }

                    // V8: Add character physical attributes from database
                    if (char.age) advancedParts.push(char.age);
                    if (char.height) advancedParts.push(char.height);
                    if (char.bodyType) advancedParts.push(char.bodyType);
                    if (char.customBodyType) advancedParts.push(char.customBodyType);

                    // Build final character section
                    if (charTags) {
                        let charSection = `[Character: ${char.name}]\n${charTags}`;
                        if (advancedParts.length > 0) {
                            charSection += `\n${advancedParts.join(', ')}`;
                        }
                        sections.push(charSection);
                    }
                }
            }

            // Scene/Action section with group tags
            const sceneActionParts = [];

            // Add group tags based on mode and character count
            if (selectedCharacters.length > 0) {
                if (currentMode === 'solo') {
                    if (format === 'standard') sceneActionParts.push('solo');
                    else if (format === 'simple-jp') sceneActionParts.push('å˜ç‹¬');
                } else if (currentMode === 'duo' || currentMode === 'comic') {
                    const count = selectedCharacters.length;
                    if (count > 1) {
                        // Count gender for group tags
                        const genders = selectedCharacters.map(c => c.builder?.gender || 'androgynous');
                        const maleCount = genders.filter(g => g === 'male').length;
                        const femaleCount = genders.filter(g => g === 'female').length;

                        if (format === 'standard') {
                            if (maleCount + femaleCount === 0 || maleCount === count) {
                                sceneActionParts.push(`${count}boys`);
                            } else if (femaleCount === count) {
                                sceneActionParts.push(`${count}girls`);
                            } else {
                                sceneActionParts.push('multiple_girls', 'multiple_boys');
                            }
                        } else if (format === 'simple-jp') {
                            sceneActionParts.push(`${count}äºº`);
                        }
                    }
                }

                // Comic mode style tags
                if (currentMode === 'comic') {
                    if (format === 'standard') sceneActionParts.push('comic', 'monochrome');
                    else if (format === 'simple-jp') sceneActionParts.push('æ¼«ç”»', 'ãƒ¢ãƒã‚¯ãƒ­');
                    else if (format === 'natural') sceneActionParts.push('comic-style monochrome illustration');
                }
            }

            // Add situation and action tags
            if (selectedSituation) sceneActionParts.push(selectedSituation.tags);
            if (selectedAction) sceneActionParts.push(selectedAction.tags);
            if (customAction) sceneActionParts.push(customAction);

            // V6: Props
            if (selectedProp) sceneActionParts.push(selectedProp.prompt);
            const customProps = document.getElementById('custom-props-input')?.value.trim();
            if (customProps) sceneActionParts.push(customProps);

            // V6: Time of Day
            const timeOfDay = document.getElementById('time-of-day-selector')?.value;
            if (timeOfDay) sceneActionParts.push(timeOfDay);

            if (sceneActionParts.length > 0) {
                const sceneSection = `[Scene/Action]\n${sceneActionParts.join(', ')}`;
                sections.push(sceneSection);
            }

            // V6: Atmosphere Settings
            const atmosphereParts = [];

            // V6: Art Styles (Multiple)
            if (selectedStyles.length > 0) {
                const stylePrompts = selectedStyles.map(styleId => {
                    const style = styles.find(s => s.id === styleId);
                    return style ? style.prompt : '';
                }).filter(p => p);
                if (stylePrompts.length > 0) {
                    atmosphereParts.push(...stylePrompts);
                }
            }

            // V6: Lineart Strength
            const lineartStrength = document.querySelector('input[name="lineart-strength"]:checked')?.value;
            if (lineartStrength) {
                atmosphereParts.push(lineartStrength);
            }

            // Color Mode
            const colorMode = document.querySelector('input[name="color-mode"]:checked')?.value;
            if (colorMode && colorMode !== 'none') {
                const color1 = document.getElementById('color-1')?.value || '#FF0000';
                const colorName1 = hexToColorName(color1);

                if (colorMode === 'monotone') {
                    atmosphereParts.push(`monotone, ${colorName1} theme`);
                } else if (colorMode === 'two-tone') {
                    const color2 = document.getElementById('color-2')?.value || '#0000FF';
                    const colorName2 = hexToColorName(color2);
                    atmosphereParts.push(`two-tone, ${colorName1} and ${colorName2}`);
                } else if (colorMode === 'background') {
                    atmosphereParts.push(`${colorName1} background`);
                } else if (colorMode === 'theme') {
                    atmosphereParts.push(`theme color is ${color1}`);
                }
            }

            // Aspect Ratio
            const aspectRatio = document.getElementById('aspect-ratio-selector')?.value;
            if (aspectRatio) {
                atmosphereParts.push(`aspect ratio ${aspectRatio}`);
            }

            if (atmosphereParts.length > 0) {
                const atmosphereSection = `[Atmosphere]\n${atmosphereParts.join(', ')}`;
                sections.push(atmosphereSection);
            }

            // Combine all sections with double line breaks
            let positivePrompt = sections.filter(s => s.trim()).join(',\n\n');

            // Add negative prompt
            const fullPrompt = negativePreset
                ? `${positivePrompt}\n\nNegative prompt: ${negativePreset}`
                : positivePrompt;

            return fullPrompt;
        }

        function updatePromptPreview() {
            generatePrompt().then(prompt => {
                document.getElementById('prompt-preview').textContent = prompt || 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™';
            });
        }

        async function copyPrompt() {
            try {
                const prompt = await generatePrompt();

                if (!prompt.trim()) {
                    alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒç©ºã§ã™ã€‚ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // Try clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(prompt);
                } else {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = prompt;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }

                const btn = document.getElementById('copy-prompt-btn');
                const originalText = btn.textContent;
                btn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);

                // Show preview in console for debugging
                console.log('ã‚³ãƒ”ãƒ¼ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:', prompt);
            } catch (err) {
                console.error('ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', err);
                alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼: ' + err.message + '\n\nHTTPSæ¥ç¶šã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function saveImages() {
            if (selectedImages.length === 0) {
                alert('ä¿å­˜ã™ã‚‹ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            selectedImages.forEach((img, index) => {
                const link = document.createElement('a');
                link.href = img.data;
                link.download = `${img.char}_${index + 1}.png`;
                link.click();
            });
        }

        // ===== Character List =====
        async function loadCharacterList() {
            const characters = await getAllCharacters();
            const container = document.getElementById('character-list');

            if (characters.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-12">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }

            container.innerHTML = characters.map(char => `
                <div class="card p-4">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-lg text-gray-800">${char.name}</h3>
                        <div class="space-x-2">
                            <button class="edit-character text-blue-500 hover:text-blue-700" data-id="${char.id}">âœï¸</button>
                            <button class="delete-character text-red-500 hover:text-red-700" data-id="${char.id}">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-2"><strong>ã‚¿ã‚°:</strong> ${char.trigger}</p>
                    <p class="text-sm text-gray-600 mb-3 line-clamp-2">${char.appearance}</p>
                    ${char.images && char.images.length > 0 ? `
                        <div class="flex gap-2 overflow-x-auto">
                            ${char.images.slice(0, 3).map(img => `
                                <img src="${img}" alt="${char.name}" class="w-16 h-16 object-cover rounded">
                            `).join('')}
                            ${char.images.length > 3 ? `<div class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center text-sm text-gray-600">+${char.images.length - 3}</div>` : ''}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // ===== Character Form =====
        function openCharacterModal(characterId = null) {
            editingCharacterId = characterId;
            const modal = document.getElementById('character-modal');
            const form = document.getElementById('character-form');
            const title = document.getElementById('modal-title');

            if (characterId) {
                title.textContent = 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç·¨é›†';
                getAllCharacters().then(characters => {
                    const character = characters.find(c => c.id === characterId);
                    if (character) {
                        document.getElementById('character-id').value = character.id;
                        document.getElementById('character-name').value = character.name;

                        // V4 Builder fields
                        if (character.builder) {
                            const b = character.builder;
                            document.querySelector(`input[name="gender"][value="${b.gender || 'androgynous'}"]`).checked = true;
                            document.getElementById('species-jp').value = b.species?.jp || '';
                            document.getElementById('species-en').value = b.species?.en || '';
                            document.getElementById('hair-jp').value = b.hair?.jp || '';
                            document.getElementById('hair-en').value = b.hair?.en || '';
                            document.getElementById('haircolor-jp').value = b.hairColor?.jp || '';
                            document.getElementById('haircolor-en').value = b.hairColor?.en || '';
                            document.getElementById('eyes-jp').value = b.eyes?.jp || '';
                            document.getElementById('eyes-en').value = b.eyes?.en || '';
                            document.getElementById('clothes-jp').value = b.clothes?.jp || '';
                            document.getElementById('clothes-en').value = b.clothes?.en || '';
                            document.getElementById('accessories-jp').value = b.accessories?.jp || '';
                            document.getElementById('accessories-en').value = b.accessories?.en || '';
                        }

                        // V8: Physical attributes
                        document.getElementById('character-age').value = character.age || '';
                        document.getElementById('character-height').value = character.height || '';
                        if (character.bodyType) {
                            const bodyTypeRadio = document.querySelector(`input[name="body-type"][value="${character.bodyType}"]`);
                            if (bodyTypeRadio) {
                                bodyTypeRadio.checked = true;
                            }
                        }
                        document.getElementById('custom-body-type').value = character.customBodyType || '';

                        const previewContainer = document.getElementById('image-preview-container');
                        if (character.images && character.images.length > 0) {
                            previewContainer.innerHTML = character.images.map((img, index) => `
                                <div class="relative">
                                    <img src="${img}" class="w-full h-20 object-cover rounded">
                                    <button type="button" class="remove-preview-image absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 text-xs" data-index="${index}">âœ•</button>
                                </div>
                            `).join('');
                        }
                    }
                });
            } else {
                title.textContent = 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»éŒ²';
                form.reset();
                document.getElementById('character-id').value = '';
                document.getElementById('image-preview-container').innerHTML = '';
            }

            modal.classList.add('show');
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
            });
            editingCharacterId = null;
        }

        async function handleImageSelection(files) {
            const previewContainer = document.getElementById('image-preview-container');
            const existingPreviews = previewContainer.querySelectorAll('img').length;

            for (let i = 0; i < files.length; i++) {
                if (existingPreviews + i >= 10) {
                    alert('ç”»åƒã¯æœ€å¤§10æšã¾ã§ç™»éŒ²ã§ãã¾ã™');
                    break;
                }

                const file = files[i];
                const reader = new FileReader();

                reader.onload = (e) => {
                    const preview = document.createElement('div');
                    preview.className = 'relative';
                    preview.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-20 object-cover rounded">
                        <button type="button" class="remove-preview-image absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 text-xs">âœ•</button>
                    `;
                    previewContainer.appendChild(preview);
                };

                reader.readAsDataURL(file);
            }
        }

        async function saveCharacter(event) {
            event.preventDefault();

            const characterData = {
                name: document.getElementById('character-name').value,
                builder: {
                    gender: document.querySelector('input[name="gender"]:checked')?.value || 'androgynous',
                    species: {
                        jp: document.getElementById('species-jp').value,
                        en: document.getElementById('species-en').value
                    },
                    hair: {
                        jp: document.getElementById('hair-jp').value,
                        en: document.getElementById('hair-en').value
                    },
                    hairColor: {
                        jp: document.getElementById('haircolor-jp').value,
                        en: document.getElementById('haircolor-en').value
                    },
                    eyes: {
                        jp: document.getElementById('eyes-jp').value,
                        en: document.getElementById('eyes-en').value
                    },
                    clothes: {
                        jp: document.getElementById('clothes-jp').value,
                        en: document.getElementById('clothes-en').value
                    },
                    accessories: {
                        jp: document.getElementById('accessories-jp').value,
                        en: document.getElementById('accessories-en').value
                    }
                },
                // V8: Physical attributes
                age: document.getElementById('character-age').value,
                height: document.getElementById('character-height').value,
                bodyType: document.querySelector('input[name="body-type"]:checked')?.value || '',
                customBodyType: document.getElementById('custom-body-type').value,
                images: Array.from(document.getElementById('image-preview-container').querySelectorAll('img'))
                    .map(img => img.src)
            };

            if (editingCharacterId) {
                characterData.id = editingCharacterId;
                await updateCharacter(characterData);
            } else {
                await addCharacter(characterData);
            }

            closeModal();
            loadCharacterList();
            renderGeneratorHub();
        }

        async function deleteCharacterConfirm(id) {
            if (!confirm('ã“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            await deleteCharacter(id);
            loadCharacterList();
            renderGeneratorHub();
        }

        // ===== Situation List (V2) =====
        async function loadSituationList() {
            const situations = await getAllSituations();
            const container = document.getElementById('situation-list');

            if (situations.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-12">ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }

            container.innerHTML = situations.map(situation => `
                <div class="card p-4">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-lg text-gray-800">${situation.name}</h3>
                        <div class="space-x-2">
                            <button class="edit-situation text-blue-500 hover:text-blue-700" data-id="${situation.id}">âœï¸</button>
                            <button class="delete-situation text-red-500 hover:text-red-700" data-id="${situation.id}">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">${situation.tags}</p>
                </div>
            `).join('');
        }

        function openSituationModal(situationId = null) {
            editingSituationId = situationId;
            const modal = document.getElementById('situation-modal');
            const title = document.getElementById('situation-modal-title');

            if (situationId) {
                title.textContent = 'ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ç·¨é›†';
                getAllSituations().then(situations => {
                    const situation = situations.find(s => s.id === situationId);
                    if (situation) {
                        document.getElementById('situation-id').value = situation.id;
                        document.getElementById('situation-name').value = situation.name;
                        document.getElementById('situation-tags').value = situation.tags;
                    }
                });
            } else {
                title.textContent = 'ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ç™»éŒ²';
                document.getElementById('situation-form').reset();
                document.getElementById('situation-id').value = '';
            }

            modal.classList.add('show');
        }

        async function saveSituation(event) {
            event.preventDefault();

            const situationData = {
                name: document.getElementById('situation-name').value,
                tags: document.getElementById('situation-tags').value
            };

            if (editingSituationId) {
                situationData.id = editingSituationId;
                await updateSituation(situationData);
            } else {
                await addSituation(situationData);
            }

            closeModal();
            loadSituationList();
            renderSituationSelector();
        }

        async function deleteSituationConfirm(id) {
            if (!confirm('ã“ã®ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            await deleteSituation(id);
            loadSituationList();
            renderSituationSelector();
        }

        // ===== Action List (V2) =====
        async function loadActionList() {
            const actions = await getAllActions();
            const container = document.getElementById('action-list');

            if (actions.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-12">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }

            container.innerHTML = actions.map(action => `
                <div class="card p-4">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-lg text-gray-800">${action.name}</h3>
                        <div class="space-x-2">
                            <button class="edit-action text-blue-500 hover:text-blue-700" data-id="${action.id}">âœï¸</button>
                            <button class="delete-action text-red-500 hover:text-red-700" data-id="${action.id}">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">${action.tags}</p>
                </div>
            `).join('');
        }

        function openActionModal(actionId = null) {
            editingActionId = actionId;
            const modal = document.getElementById('action-modal');
            const title = document.getElementById('action-modal-title');

            if (actionId) {
                title.textContent = 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç·¨é›†';
                getAllActions().then(actions => {
                    const action = actions.find(a => a.id === actionId);
                    if (action) {
                        document.getElementById('action-id').value = action.id;
                        document.getElementById('action-name').value = action.name;
                        document.getElementById('action-tags').value = action.tags;
                    }
                });
            } else {
                title.textContent = 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç™»éŒ²';
                document.getElementById('action-form').reset();
                document.getElementById('action-id').value = '';
            }

            modal.classList.add('show');
        }

        async function saveAction(event) {
            event.preventDefault();

            const actionData = {
                name: document.getElementById('action-name').value,
                tags: document.getElementById('action-tags').value
            };

            if (editingActionId) {
                actionData.id = editingActionId;
                await updateAction(actionData);
            } else {
                await addAction(actionData);
            }

            closeModal();
            loadActionList();
            renderActionSelector();
        }

        async function deleteActionConfirm(id) {
            if (!confirm('ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            await deleteAction(id);
            loadActionList();
            renderActionSelector();
        }

        // ===== Style Management (V5) =====
        let editingStyleId = null;

        async function loadStyleList() {
            const styles = await getAllStyles();
            const container = document.getElementById('style-list');

            if (styles.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-12">ã‚¹ã‚¿ã‚¤ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }

            container.innerHTML = styles.map(style => `
                <div class="card p-4">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-lg text-gray-800">${style.name}</h3>
                        <div class="space-x-2">
                            <button class="edit-style text-blue-500 hover:text-blue-700" data-id="${style.id}">âœï¸</button>
                            <button class="delete-style text-red-500 hover:text-red-700" data-id="${style.id}">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">${style.prompt}</p>
                </div>
            `).join('');
        }

        function openStyleModal(styleId = null) {
            editingStyleId = styleId;
            const modal = document.getElementById('style-modal');
            const title = document.getElementById('style-modal-title');

            if (styleId) {
                title.textContent = 'ã‚¹ã‚¿ã‚¤ãƒ«ç·¨é›†';
                getAllStyles().then(styles => {
                    const style = styles.find(s => s.id === styleId);
                    if (style) {
                        document.getElementById('style-id').value = style.id;
                        document.getElementById('style-name').value = style.name;
                        document.getElementById('style-prompt').value = style.prompt;
                    }
                });
            } else {
                title.textContent = 'ã‚¹ã‚¿ã‚¤ãƒ«ç™»éŒ²';
                document.getElementById('style-form').reset();
                document.getElementById('style-id').value = '';
            }

            modal.classList.add('show');
        }

        async function saveStyle(event) {
            event.preventDefault();

            const styleData = {
                name: document.getElementById('style-name').value,
                prompt: document.getElementById('style-prompt').value
            };

            if (editingStyleId) {
                styleData.id = editingStyleId;
                await updateStyle(styleData);
            } else {
                await addStyle(styleData);
            }

            closeModal();
            loadStyleList();
            loadStyleSelector();
        }

        async function deleteStyleConfirm(id) {
            if (!confirm('ã“ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            await deleteStyle(id);
            loadStyleList();
            loadStyleCheckboxes();
        }

        // ===== Props Management (V6) =====
        let editingPropId = null;
        let props = [];
        let selectedProp = null;

        async function loadPropsList() {
            const allProps = await getAllProps();
            const container = document.getElementById('props-list');

            if (allProps.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-12">å°ç‰©ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }

            container.innerHTML = allProps.map(prop => `
                <div class="card p-4">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-lg text-gray-800">${prop.name}</h3>
                        <div class="space-x-2">
                            <button class="edit-prop text-blue-500 hover:text-blue-700" data-id="${prop.id}">âœï¸</button>
                            <button class="delete-prop text-red-500 hover:text-red-700" data-id="${prop.id}">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">${prop.prompt}</p>
                </div>
            `).join('');
        }

        function openPropsModal(propId = null) {
            editingPropId = propId;
            const modal = document.getElementById('props-modal');
            const title = document.getElementById('props-modal-title');

            if (propId) {
                title.textContent = 'å°ç‰©ç·¨é›†';
                getAllProps().then(allProps => {
                    const prop = allProps.find(p => p.id === propId);
                    if (prop) {
                        document.getElementById('prop-id').value = prop.id;
                        document.getElementById('prop-name').value = prop.name;
                        document.getElementById('prop-prompt').value = prop.prompt;
                    }
                });
            } else {
                title.textContent = 'å°ç‰©ç™»éŒ²';
                document.getElementById('props-form').reset();
                document.getElementById('prop-id').value = '';
            }

            modal.classList.add('show');
        }

        async function saveProp(event) {
            event.preventDefault();

            const propData = {
                name: document.getElementById('prop-name').value,
                prompt: document.getElementById('prop-prompt').value
            };

            if (editingPropId) {
                propData.id = editingPropId;
                await updateProp(propData);
            } else {
                await addProp(propData);
            }

            closeModal();
            loadPropsList();
            renderPropsSelector();
        }

        async function deletePropConfirm(id) {
            if (!confirm('ã“ã®å°ç‰©ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            await deleteProp(id);
            loadPropsList();
            renderPropsSelector();
        }

        async function renderPropsSelector() {
            props = await getAllProps();
            const container = document.getElementById('props-selector');

            let html = '<button class="props-btn p-3 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition" data-id="">æŒ‡å®šãªã—</button>';

            props.forEach(prop => {
                const activeClass = selectedProp?.id === prop.id ? 'active' : '';
                html += `<button class="props-btn ${activeClass} p-3 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition" data-id="${prop.id}">${prop.name}</button>`;
            });

            container.innerHTML = html;
        }

        function selectProp(id) {
            if (!id) {
                selectedProp = null;
            } else {
                selectedProp = props.find(p => p.id == id);
            }

            document.querySelectorAll('.props-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            const activeBtn = document.querySelector(`.props-btn[data-id="${id}"]`);
            if (activeBtn) activeBtn.classList.add('active');

            updatePromptPreview();
        }

        // ===== Project Management (V3) =====
        async function loadProjectList() {
            const projects = await getAllProjects();
            const container = document.getElementById('project-list');

            if (projects.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-12">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“<br>ã€Œâ• æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„</div>';
                return;
            }

            container.innerHTML = projects.map(project => `
                <div class="card p-4 cursor-pointer hover:shadow-lg transition project-card" data-id="${project.id}">
                    <h3 class="font-bold text-lg text-gray-800 mb-2">${project.title}</h3>
                    <p class="text-sm text-gray-600 line-clamp-3 mb-3">${project.plot || 'ãƒ—ãƒ­ãƒƒãƒˆãªã—'}</p>
                    <div class="text-xs text-gray-400">ä½œæˆæ—¥: ${new Date(project.createdAt).toLocaleDateString()}</div>
                </div>
            `).join('');

            // Show project list view
            document.getElementById('project-list-view').classList.remove('hidden');
            document.getElementById('project-detail-view').classList.add('hidden');
        }

        async function openProject(projectId) {
            currentProjectId = projectId;
            currentProject = await getProject(projectId);

            // Update UI
            document.getElementById('project-title-display').textContent = currentProject.title;
            document.getElementById('project-plot-display').textContent = currentProject.plot || 'ãƒ—ãƒ­ãƒƒãƒˆã®èª¬æ˜ãŒã‚ã‚Šã¾ã›ã‚“';

            // Load style presets
            document.getElementById('style-monochrome').checked = currentProject.styleMonochrome || false;
            document.getElementById('style-fullcolor').checked = currentProject.styleFullColor || false;
            document.getElementById('style-4koma').checked = currentProject.style4Koma || false;

            // Load pages
            await loadPages(projectId);

            // Switch views
            document.getElementById('project-list-view').classList.add('hidden');
            document.getElementById('project-detail-view').classList.remove('hidden');
        }

        function openProjectModal(projectId = null) {
            editingProjectId = projectId;
            const modal = document.getElementById('project-modal');
            const title = document.getElementById('project-modal-title');

            if (projectId) {
                title.textContent = 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†';
                getProject(projectId).then(project => {
                    if (project) {
                        document.getElementById('project-id').value = project.id;
                        document.getElementById('project-title').value = project.title;
                        document.getElementById('project-plot').value = project.plot || '';
                    }
                });
            } else {
                title.textContent = 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ';
                document.getElementById('project-form').reset();
                document.getElementById('project-id').value = '';
            }

            modal.classList.add('show');
        }

        async function saveProject(event) {
            event.preventDefault();

            const projectData = {
                title: document.getElementById('project-title').value,
                plot: document.getElementById('project-plot').value
            };

            if (editingProjectId) {
                projectData.id = editingProjectId;
                await updateProject(projectData);
            } else {
                const newId = await addProject(projectData);
                currentProjectId = newId;
            }

            closeModal();
            loadProjectList();
        }

        async function deleteProjectConfirm() {
            if (!confirm('ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨å…¨ã¦ã®ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            // Delete all pages first
            const pages = await getPagesByProject(currentProjectId);
            for (const page of pages) {
                await deletePage(page.id);
            }

            await deleteProject(currentProjectId);
            currentProjectId = null;
            loadProjectList();
        }

        async function updateProjectStyles() {
            if (!currentProject) return;

            currentProject.styleMonochrome = document.getElementById('style-monochrome').checked;
            currentProject.styleFullColor = document.getElementById('style-fullcolor').checked;
            currentProject.style4Koma = document.getElementById('style-4koma').checked;

            await updateProject(currentProject);
            loadPages(currentProjectId); // Reload pages to update prompts
        }

        // ===== Page Management (V3) =====
        async function loadPages(projectId) {
            const pages = await getPagesByProject(projectId);
            const container = document.getElementById('pages-container');

            if (pages.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">ãƒšãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“<br>ã€Œâ• ãƒšãƒ¼ã‚¸è¿½åŠ ã€ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„</div>';
                return;
            }

            container.innerHTML = pages.map((page, index) => `
                <div class="card p-4 page-accordion" data-page-id="${page.id}">
                    <div class="flex justify-between items-center cursor-pointer page-header" data-page-id="${page.id}">
                        <h4 class="font-bold text-gray-800">ğŸ“„ Page ${index + 1}</h4>
                        <div class="space-x-2 flex items-center">
                            <button class="delete-page text-red-500 hover:text-red-700 text-sm" data-page-id="${page.id}">ğŸ—‘ï¸</button>
                            <span class="toggle-icon text-gray-400">â–¼</span>
                        </div>
                    </div>

                    <div class="page-content mt-4 ${openPageId === page.id ? '' : 'hidden'}" data-page-id="${page.id}">
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-600 mb-2">ãƒšãƒ¼ã‚¸ãƒ¡ãƒ¢</label>
                            <textarea class="page-memo w-full px-3 py-2 border rounded-lg text-sm" rows="3" data-page-id="${page.id}">${page.memo || ''}</textarea>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-600 mb-2">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
                            <div class="page-prompt-preview bg-gray-50 p-3 rounded text-xs font-mono whitespace-pre-wrap">${generatePagePrompt(page)}</div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-600 mb-2">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ</label>
                            <div class="page-character-selector flex flex-wrap gap-2" data-page-id="${page.id}">
                                ${renderPageCharacterSelector(page)}
                            </div>
                        </div>

                        <!-- V8: Panel Configuration -->
                        <div class="mb-4 border-t pt-4">
                            <div class="mb-3">
                                <label class="block text-sm font-semibold text-gray-600 mb-2">ğŸ“ 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®ã‚³ãƒæ•°</label>
                                <select class="panels-per-page w-full px-3 py-2 border rounded-lg text-sm" data-page-id="${page.id}">
                                    <option value="1" ${(page.panelsPerPage || 1) === 1 ? 'selected' : ''}>1ã‚³ãƒï¼ˆ1æšï¼‰</option>
                                    <option value="2" ${page.panelsPerPage === 2 ? 'selected' : ''}>2ã‚³ãƒ</option>
                                    <option value="3" ${page.panelsPerPage === 3 ? 'selected' : ''}>3ã‚³ãƒ</option>
                                    <option value="4" ${page.panelsPerPage === 4 ? 'selected' : ''}>4ã‚³ãƒ</option>
                                    <option value="6" ${page.panelsPerPage === 6 ? 'selected' : ''}>6ã‚³ãƒ</option>
                                </select>
                            </div>

                            <div class="page-panels-container space-y-3" data-page-id="${page.id}">
                                ${renderPanelConfigs(page)}
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-sm font-semibold text-gray-600 mb-1">å ´æ‰€</label>
                                <select class="page-situation w-full px-2 py-1 border rounded text-sm" data-page-id="${page.id}">
                                    <option value="">æŒ‡å®šãªã—</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-600 mb-1">è¡Œå‹•</label>
                                <select class="page-action w-full px-2 py-1 border rounded text-sm" data-page-id="${page.id}">
                                    <option value="">æŒ‡å®šãªã—</option>
                                </select>
                            </div>
                        </div>

                        <textarea class="page-custom-action w-full px-3 py-2 border rounded-lg text-sm mt-2" rows="2" placeholder="ã‚«ã‚¹ã‚¿ãƒ è¡Œå‹•..." data-page-id="${page.id}">${page.customAction || ''}</textarea>

                        <button class="copy-page-prompt btn-primary text-white px-4 py-2 rounded-lg w-full mt-3 text-sm" data-page-id="${page.id}">
                            ğŸ“‹ ã“ã®ãƒšãƒ¼ã‚¸ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                </div>
            `).join('');

            // Populate situation and action selects
            const situations = await getAllSituations();
            const actions = await getAllActions();

            pages.forEach(page => {
                const situationSelect = container.querySelector(`.page-situation[data-page-id="${page.id}"]`);
                const actionSelect = container.querySelector(`.page-action[data-page-id="${page.id}"]`);

                situations.forEach(sit => {
                    const option = document.createElement('option');
                    option.value = sit.id;
                    option.textContent = sit.name;
                    if (page.situationId === sit.id) option.selected = true;
                    situationSelect.appendChild(option);
                });

                actions.forEach(act => {
                    const option = document.createElement('option');
                    option.value = act.id;
                    option.textContent = act.name;
                    if (page.actionId === act.id) option.selected = true;
                    actionSelect.appendChild(option);
                });
            });
        }

        function renderPageCharacterSelector(page) {
            // Simple character checkbox list
            const selectedIds = page.characterIds || [];
            return ''; // Will be populated dynamically
        }

        // V8: Render panel configurations for a page
        function renderPanelConfigs(page) {
            const panelCount = page.panelsPerPage || 1;
            const panels = page.panels || [];

            // Ensure panels array matches panelCount
            while (panels.length < panelCount) {
                panels.push({ characterNames: [], composition: '', isBackgroundOnly: false, customDescription: '' });
            }

            return Array.from({ length: panelCount }, (_, i) => {
                const panel = panels[i] || { characterNames: [], composition: '', isBackgroundOnly: false, customDescription: '' };

                return `
                    <div class="border rounded-lg p-3 bg-gray-50">
                        <div class="flex justify-between items-center mb-2">
                            <h5 class="font-semibold text-gray-700 text-sm">ğŸ¬ ã‚³ãƒ ${i + 1}</h5>
                            <label class="flex items-center text-xs cursor-pointer">
                                <input type="checkbox" class="panel-bg-only mr-1" data-page-id="${page.id}" data-panel-index="${i}" ${panel.isBackgroundOnly ? 'checked' : ''}>
                                <span>èƒŒæ™¯ã®ã¿</span>
                            </label>
                        </div>

                        ${!panel.isBackgroundOnly ? `
                            <div class="mb-2">
                                <label class="block text-xs text-gray-600 mb-1">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åï¼ˆè¤‡æ•°å¯ï¼‰</label>
                                <input type="text" class="panel-characters w-full px-2 py-1 border rounded text-xs"
                                    data-page-id="${page.id}" data-panel-index="${i}"
                                    value="${(panel.characterNames || []).join(', ')}"
                                    placeholder="ä¾‹ï¼šã‚«ãƒŸãƒ«, ãƒªãƒ³">
                            </div>

                            <div class="mb-2">
                                <label class="block text-xs text-gray-600 mb-1">æ§‹å›³</label>
                                <select class="panel-composition w-full px-2 py-1 border rounded text-xs"
                                    data-page-id="${page.id}" data-panel-index="${i}">
                                    <option value="">æŒ‡å®šãªã—</option>
                                    <option value="face only" ${panel.composition === 'face only' ? 'selected' : ''}>é¡”ã ã‘</option>
                                    <option value="face focus, close-up" ${panel.composition === 'face focus, close-up' ? 'selected' : ''}>é¡”ã‚¢ãƒƒãƒ—</option>
                                    <option value="upper body, bust shot" ${panel.composition === 'upper body, bust shot' ? 'selected' : ''}>ãƒã‚¹ãƒˆã‚¢ãƒƒãƒ—</option>
                                    <option value="upper body" ${panel.composition === 'upper body' ? 'selected' : ''}>ä¸ŠåŠèº«</option>
                                    <option value="cowboy shot" ${panel.composition === 'cowboy shot' ? 'selected' : ''}>å¤ªã‚‚ã‚‚ã‹ã‚‰ä¸Š</option>
                                    <option value="full body" ${panel.composition === 'full body' ? 'selected' : ''}>å…¨èº«</option>
                                </select>
                            </div>
                        ` : ''}

                        <div>
                            <label class="block text-xs text-gray-600 mb-1">ã‚«ã‚¹ã‚¿ãƒ èª¬æ˜</label>
                            <input type="text" class="panel-custom w-full px-2 py-1 border rounded text-xs"
                                data-page-id="${page.id}" data-panel-index="${i}"
                                value="${panel.customDescription || ''}"
                                placeholder="ä¾‹ï¼šå¤•ç„¼ã‘ã®èƒŒæ™¯ã€åŠ¹æœç·š">
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generatePagePrompt(page) {
            let parts = [];

            // Add style tags
            if (currentProject) {
                if (currentProject.styleMonochrome) parts.push('monochrome, greyscale, comic');
                else if (currentProject.styleFullColor) parts.push('full color, comic');
                else if (currentProject.style4Koma) parts.push('4koma, comic');
            }

            // Character, situation, action will be added here
            if (page.promptCache) return page.promptCache;

            return parts.join(', ') || 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆä¸­...';
        }

        async function addPageToProject() {
            if (!currentProjectId) return;

            const pages = await getPagesByProject(currentProjectId);
            const newPage = {
                projectId: currentProjectId,
                order: pages.length,
                memo: '',
                characterIds: [],
                situationId: null,
                actionId: null,
                customAction: '',
                // V8: Panel configuration
                panelsPerPage: 1,
                panels: [{ characterNames: [], composition: '', isBackgroundOnly: false, customDescription: '' }]
            };

            await addPage(newPage);
            loadPages(currentProjectId);
        }

        async function deletePageConfirm(pageId) {
            if (!confirm('ã“ã®ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            await deletePage(pageId);
            loadPages(currentProjectId);
        }

        async function updatePageData(pageId, field, value) {
            const pages = await getPagesByProject(currentProjectId);
            const page = pages.find(p => p.id === pageId);
            if (!page) return;

            page[field] = value;
            await updatePage(page);
        }

        // V8: Update panels per page and regenerate panel configs
        async function updatePanelsPerPage(pageId, panelCount) {
            const pages = await getPagesByProject(currentProjectId);
            const page = pages.find(p => p.id === pageId);
            if (!page) return;

            page.panelsPerPage = panelCount;

            // Initialize panels array if needed
            if (!page.panels) page.panels = [];

            // Adjust panels array to match new count
            while (page.panels.length < panelCount) {
                page.panels.push({ characterNames: [], composition: '', isBackgroundOnly: false, customDescription: '' });
            }
            if (page.panels.length > panelCount) {
                page.panels = page.panels.slice(0, panelCount);
            }

            await updatePage(page);

            // Re-render the panel configs
            const container = document.querySelector(`.page-panels-container[data-page-id="${pageId}"]`);
            if (container) {
                container.innerHTML = renderPanelConfigs(page);
            }
        }

        // V8: Update individual panel data
        async function updatePanelData(pageId, panelIndex, field, value) {
            const pages = await getPagesByProject(currentProjectId);
            const page = pages.find(p => p.id === pageId);
            if (!page) return;

            if (!page.panels) page.panels = [];
            if (!page.panels[panelIndex]) {
                page.panels[panelIndex] = { characterNames: [], composition: '', isBackgroundOnly: false, customDescription: '' };
            }

            page.panels[panelIndex][field] = value;

            // If background only is toggled, re-render the panel
            if (field === 'isBackgroundOnly') {
                await updatePage(page);
                const container = document.querySelector(`.page-panels-container[data-page-id="${pageId}"]`);
                if (container) {
                    container.innerHTML = renderPanelConfigs(page);
                }
            } else {
                await updatePage(page);
            }
        }

        function togglePageAccordion(pageId) {
            const content = document.querySelector(`.page-content[data-page-id="${pageId}"]`);
            const icon = document.querySelector(`.page-header[data-page-id="${pageId}"] .toggle-icon`);

            if (content.classList.contains('hidden')) {
                // Close all other pages
                document.querySelectorAll('.page-content').forEach(c => c.classList.add('hidden'));
                document.querySelectorAll('.toggle-icon').forEach(i => i.textContent = 'â–¼');

                // Open this page
                content.classList.remove('hidden');
                icon.textContent = 'â–²';
                openPageId = pageId;
            } else {
                content.classList.add('hidden');
                icon.textContent = 'â–¼';
                openPageId = null;
            }
        }

        // ===== Settings =====
        async function loadSettings() {
            const positivePreset = await getSetting('positivePreset', 'masterpiece, best quality, ultra detailed, 8k resolution');
            const negativePreset = await getSetting('negativePreset', 'low quality, worst quality, blurry, bad anatomy, watermark');

            document.getElementById('positive-preset').value = positivePreset;
            document.getElementById('negative-preset').value = negativePreset;
        }

        async function saveSettings() {
            const positivePreset = document.getElementById('positive-preset').value;
            const negativePreset = document.getElementById('negative-preset').value;

            await saveSetting('positivePreset', positivePreset);
            await saveSetting('negativePreset', negativePreset);

            const btn = document.getElementById('save-presets-btn');
            const originalText = btn.textContent;
            btn.textContent = 'âœ… ä¿å­˜ã—ã¾ã—ãŸï¼';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        }

        // ===== Import/Export (V2) =====
        async function exportJSON() {
            const characters = await getAllCharacters();
            const situations = await getAllSituations();
            const actions = await getAllActions();
            const positivePreset = await getSetting('positivePreset', '');
            const negativePreset = await getSetting('negativePreset', '');

            const data = {
                version: 2,
                characters,
                situations,
                actions,
                settings: {
                    positivePreset,
                    negativePreset
                }
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `nanobanana-v2-backup-${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const data = JSON.parse(text);

                    if (!data.version || !data.characters) {
                        throw new Error('Invalid JSON format');
                    }

                    let message = `${data.characters.length}ä»¶ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼`;
                    if (data.situations) message += `, ${data.situations.length}ä»¶ã®ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³`;
                    if (data.actions) message += `, ${data.actions.length}ä»¶ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³`;
                    message += 'ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ';

                    if (!confirm(message)) {
                        return;
                    }

                    // Clear existing data
                    const characters = await getAllCharacters();
                    for (const char of characters) {
                        await deleteCharacter(char.id);
                    }

                    const situations = await getAllSituations();
                    for (const sit of situations) {
                        await deleteSituation(sit.id);
                    }

                    const actions = await getAllActions();
                    for (const act of actions) {
                        await deleteAction(act.id);
                    }

                    // Import characters
                    for (const char of data.characters) {
                        delete char.id;
                        await addCharacter(char);
                    }

                    // Import situations (V2)
                    if (data.situations) {
                        for (const sit of data.situations) {
                            delete sit.id;
                            await addSituation(sit);
                        }
                    }

                    // Import actions (V2)
                    if (data.actions) {
                        for (const act of data.actions) {
                            delete act.id;
                            await addAction(act);
                        }
                    }

                    // Import settings
                    if (data.settings) {
                        await saveSetting('positivePreset', data.settings.positivePreset || '');
                        await saveSetting('negativePreset', data.settings.negativePreset || '');
                    }

                    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
                    loadCharacterList();
                    loadSituationList();
                    loadActionList();
                    renderGeneratorHub();
                } catch (err) {
                    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                }
            };

            input.click();
        }

        // ===== Accordion Functions (V5) =====
        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.icon');

            // Toggle collapsed class
            header.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        // ===== V5 Atmosphere Functions =====
        let selectedStyles = []; // V6: Multiple styles
        let styles = [];

        async function loadStyleCheckboxes() {
            styles = await getAllStyles();
            const container = document.getElementById('art-style-checkboxes');

            if (styles.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-400">ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>';
                return;
            }

            container.innerHTML = styles.map(style => `
                <label class="flex items-center space-x-2 p-2 hover:bg-blue-50 rounded cursor-pointer">
                    <input type="checkbox" class="style-checkbox w-4 h-4" data-id="${style.id}">
                    <span class="text-sm">${style.name}</span>
                </label>
            `).join('');

            // Add event listeners to checkboxes
            container.querySelectorAll('.style-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const styleId = parseInt(e.target.dataset.id);
                    if (e.target.checked) {
                        if (!selectedStyles.includes(styleId)) {
                            selectedStyles.push(styleId);
                        }
                    } else {
                        selectedStyles = selectedStyles.filter(id => id !== styleId);
                    }
                    updatePromptPreview();
                });
            });
        }

        function updateColorMode() {
            const mode = document.querySelector('input[name="color-mode"]:checked')?.value;
            const color2Row = document.getElementById('color-2-row');
            const colorPickerContainer = document.getElementById('color-picker-container');

            if (mode === 'two-tone') {
                color2Row.classList.remove('hidden');
            } else {
                color2Row.classList.add('hidden');
            }

            if (mode === 'none') {
                colorPickerContainer.classList.add('hidden');
            } else {
                colorPickerContainer.classList.remove('hidden');
            }
        }

        function updateColorHex(colorInputId, hexSpanId) {
            const colorInput = document.getElementById(colorInputId);
            const hexSpan = document.getElementById(hexSpanId);
            hexSpan.textContent = colorInput.value.toUpperCase();
        }

        function hexToColorName(hex) {
            // Simple color name mapping for common colors
            const colorMap = {
                '#FF0000': 'red', '#00FF00': 'green', '#0000FF': 'blue',
                '#FFFF00': 'yellow', '#FF00FF': 'magenta', '#00FFFF': 'cyan',
                '#000000': 'black', '#FFFFFF': 'white', '#808080': 'gray',
                '#FFA500': 'orange', '#800080': 'purple', '#FFC0CB': 'pink',
                '#A52A2A': 'brown', '#FFD700': 'gold', '#C0C0C0': 'silver'
            };
            return colorMap[hex.toUpperCase()] || hex;
        }

        // ===== V9: Firebase Initialization =====
        let firebaseApp = null;
        let firebaseAuth = null;
        let firebaseDb = null;

        function initFirebase() {
            const firebaseConfig = {
                apiKey: "AIzaSyCfTKB1P9x7ZafKIV0Lte74kHgQd5lwVP0",
                authDomain: "aidatabaseapp.firebaseapp.com",
                projectId: "aidatabaseapp",
                storageBucket: "aidatabaseapp.firebasestorage.app",
                messagingSenderId: "219270441460",
                appId: "1:219270441460:web:c18b2952f6f86f566fb1a1",
                measurementId: "G-XVKJ81EJDW"
            };

            if (typeof firebase !== 'undefined' && !firebaseApp) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                firebaseAuth = firebase.auth();
                firebaseDb = firebase.firestore();
            }
        }

        // ===== V9: Costume Management =====
        async function loadCostumeList() {
            const costumes = await getAllCostumes();
            const container = document.getElementById('costume-list');

            if (costumes.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 col-span-full py-8">ã‚³ã‚¹ãƒãƒ¥ãƒ¼ãƒ ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>';
                return;
            }

            container.innerHTML = costumes.map(costume => `
                <div class="card p-4">
                    <h3 class="font-bold text-gray-800 mb-2">${costume.name}</h3>
                    <div class="text-sm text-gray-600 mb-3">
                        ${costume.fullSet ? `<p><strong>å…¨èº«:</strong> ${costume.fullSet.substring(0, 50)}...</p>` : ''}
                        ${costume.top ? `<p><strong>Top:</strong> ${costume.top.substring(0, 30)}...</p>` : ''}
                        ${costume.bottom ? `<p><strong>Bottom:</strong> ${costume.bottom.substring(0, 30)}...</p>` : ''}
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editCostume(${costume.id})" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm transition">
                            âœï¸ ç·¨é›†
                        </button>
                        <button onclick="deleteCostumeConfirm(${costume.id})" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm transition">
                            ğŸ—‘ï¸ å‰Šé™¤
                        </button>
                    </div>
                </div>
            `).join('');

            // Update costume selector in Generator
            await updateCostumeSelector();
        }

        async function updateCostumeSelector() {
            const costumes = await getAllCostumes();
            const selector = document.getElementById('costume-selector');

            selector.innerHTML = '<option value="">è¡£è£…ã‚’é¸æŠã—ãªã„ï¼ˆã‚­ãƒ£ãƒ©å›ºæœ‰ã®è¡£è£…ã‚’ä½¿ç”¨ï¼‰</option>' +
                costumes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        function showCostumeModal(costumeId = null) {
            const modal = document.getElementById('costume-modal');
            const form = document.getElementById('costume-form');
            const title = document.getElementById('costume-modal-title');

            form.reset();
            document.getElementById('costume-id').value = '';

            if (costumeId) {
                title.textContent = 'ã‚³ã‚¹ãƒãƒ¥ãƒ¼ãƒ ç·¨é›†';
                getAllCostumes().then(costumes => {
                    const costume = costumes.find(c => c.id === costumeId);
                    if (costume) {
                        document.getElementById('costume-id').value = costume.id;
                        document.getElementById('costume-name').value = costume.name;
                        document.getElementById('costume-fullset').value = costume.fullSet || '';
                        document.getElementById('costume-top').value = costume.top || '';
                        document.getElementById('costume-bottom').value = costume.bottom || '';
                        document.getElementById('costume-acc-a').value = costume.accA || '';
                        document.getElementById('costume-acc-b').value = costume.accB || '';
                    }
                });
            } else {
                title.textContent = 'ã‚³ã‚¹ãƒãƒ¥ãƒ¼ãƒ ç™»éŒ²';
            }

            modal.classList.add('show');
        }

        function editCostume(id) {
            showCostumeModal(id);
        }

        async function deleteCostumeConfirm(id) {
            if (confirm('ã“ã®ã‚³ã‚¹ãƒãƒ¥ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
                await deleteCostume(id);
                await loadCostumeList();
            }
        }

        // ===== V9: History Management =====
        let currentHistoryFilter = 'all'; // 'all' or 'favorites'

        async function loadHistoryList(filter = 'all') {
            currentHistoryFilter = filter;
            let history = await getAllHistory();

            if (filter === 'favorites') {
                history = history.filter(h => h.favorite);
            }

            const container = document.getElementById('history-list');

            if (history.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">ç”Ÿæˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            container.innerHTML = history.map(item => {
                const date = new Date(item.timestamp);
                const dateStr = date.toLocaleString('ja-JP');
                return `
                    <div class="card p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">${item.characterName || 'ä¸æ˜'}</h4>
                                <p class="text-xs text-gray-500">${dateStr}</p>
                            </div>
                            <button onclick="toggleHistoryFavorite(${item.id}, ${!item.favorite})"
                                class="text-2xl ${item.favorite ? 'text-yellow-500' : 'text-gray-300'} hover:text-yellow-500 transition">
                                ${item.favorite ? 'â˜…' : 'â˜†'}
                            </button>
                        </div>
                        <div class="bg-gray-50 p-3 rounded text-sm text-gray-700 mb-3 max-h-32 overflow-y-auto font-mono text-xs">
                            ${item.prompt.substring(0, 200)}${item.prompt.length > 200 ? '...' : ''}
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="reuseHistory(${item.id})" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm transition">
                                ğŸ”„ å†é©ç”¨
                            </button>
                            <button onclick="copyHistoryPrompt(${item.id})" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm transition">
                                ğŸ“‹ ã‚³ãƒ”ãƒ¼
                            </button>
                            <button onclick="deleteHistoryItem(${item.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm transition">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function saveToHistory(prompt, characterName) {
            await addHistory({
                prompt: prompt,
                characterName: characterName,
                favorite: false
            });
        }

        async function toggleHistoryFavorite(id, favorite) {
            const history = await getAllHistory();
            const item = history.find(h => h.id === id);
            if (item) {
                item.favorite = favorite;
                await updateHistory(item);
                await loadHistoryList(currentHistoryFilter);
            }
        }

        async function deleteHistoryItem(id) {
            if (confirm('ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
                await deleteHistory(id);
                await loadHistoryList(currentHistoryFilter);
            }
        }

        async function copyHistoryPrompt(id) {
            const history = await getAllHistory();
            const item = history.find(h => h.id === id);
            if (item) {
                await navigator.clipboard.writeText(item.prompt);
                alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }
        }

        async function reuseHistory(id) {
            const history = await getAllHistory();
            const item = history.find(h => h.id === id);
            if (item && confirm('ã“ã®å±¥æ­´ã®è¨­å®šã‚’å†é©ç”¨ã—ã¾ã™ã‹?\nâ€»ç¾åœ¨ã®è¨­å®šãŒä¸Šæ›¸ãã•ã‚Œã¾ã™')) {
                // Simply copy the prompt for now
                document.getElementById('prompt-preview').textContent = item.prompt;
                switchTab('generator');
                alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«è¡¨ç¤ºã—ã¾ã—ãŸ');
            }
        }

        // ===== V9: Firebase Sync Functions =====
        async function handleFirebaseLogin() {
            if (!firebaseAuth) {
                alert('FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nâ€»ãƒ‡ãƒ¢ç‰ˆã§ã¯Firebaseè¨­å®šãŒå¿…è¦ã§ã™ã€‚');
                return;
            }

            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await firebaseAuth.signInWithPopup(provider);
                updateFirebaseUI();
            } catch (error) {
                console.error('Login error:', error);
                alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function handleFirebaseLogout() {
            if (firebaseAuth) {
                await firebaseAuth.signOut();
                updateFirebaseUI();
            }
        }

        function updateFirebaseUI() {
            const loginSection = document.getElementById('firebase-login-section');
            const syncSection = document.getElementById('firebase-sync-section');
            const userEmail = document.getElementById('firebase-user-email');

            if (firebaseAuth && firebaseAuth.currentUser) {
                loginSection.classList.add('hidden');
                syncSection.classList.remove('hidden');
                userEmail.textContent = firebaseAuth.currentUser.email;
            } else {
                loginSection.classList.remove('hidden');
                syncSection.classList.add('hidden');
            }
        }

        async function handleFirebaseUpload() {
            if (!firebaseAuth || !firebaseAuth.currentUser || !firebaseDb) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const data = {
                    characters: await getAllCharacters(),
                    situations: await getAllSituations(),
                    actions: await getAllActions(),
                    styles: await getAllStyles(),
                    props: await getAllProps(),
                    costumes: await getAllCostumes(),
                    history: await getAllHistory(),
                    timestamp: Date.now()
                };

                await firebaseDb.collection('backups').doc(firebaseAuth.currentUser.uid).set(data);
                alert('ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ!');
            } catch (error) {
                console.error('Upload error:', error);
                alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function handleFirebaseDownload() {
            if (!firebaseAuth || !firebaseAuth.currentUser || !firebaseDb) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm('ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚\nç¶šè¡Œã—ã¾ã™ã‹?')) {
                return;
            }

            try {
                const doc = await firebaseDb.collection('backups').doc(firebaseAuth.currentUser.uid).get();

                if (!doc.exists) {
                    alert('ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    return;
                }

                const data = doc.data();

                // Clear and restore data
                if (data.characters) {
                    for (const char of data.characters) {
                        delete char.id;
                        await addCharacter(char);
                    }
                }
                if (data.costumes) {
                    for (const costume of data.costumes) {
                        delete costume.id;
                        await addCostume(costume);
                    }
                }
                if (data.history) {
                    for (const hist of data.history) {
                        delete hist.id;
                        await addHistory(hist);
                    }
                }

                alert('ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ!');
                location.reload();
            } catch (error) {
                console.error('Download error:', error);
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ===== Event Listeners (V2) =====
        document.addEventListener('DOMContentLoaded', async () => {
            await initDB();

            // Tab navigation
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });

            // Database sub-tabs (V2)
            document.querySelectorAll('.db-subtab').forEach(btn => {
                btn.addEventListener('click', () => switchDBSubtab(btn.dataset.subtab));
            });

            // Mode selection (V2)
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => switchMode(btn.dataset.mode));
            });

            // Character selection (V2)
            document.getElementById('character-selector').addEventListener('click', (e) => {
                const card = e.target.closest('.character-card');
                if (card) {
                    toggleCharacterSelection(card.dataset.id);
                }
            });

            // Situation selection (V2)
            document.getElementById('situation-selector').addEventListener('click', (e) => {
                if (e.target.classList.contains('situation-btn')) {
                    selectSituation(e.target.dataset.id);
                }
            });

            // Action selection (V2)
            document.getElementById('action-selector').addEventListener('click', (e) => {
                if (e.target.classList.contains('action-btn')) {
                    selectAction(e.target.dataset.id);
                }
            });

            // Custom action input (V2)
            document.getElementById('custom-action-input').addEventListener('input', updatePromptPreview);

            // Quality toggle (V2)
            document.getElementById('quality-positive-toggle').addEventListener('change', updatePromptPreview);
            document.getElementById('quality-negative-toggle').addEventListener('change', updatePromptPreview);
            document.getElementById('auto-person-tags')?.addEventListener('change', updatePromptPreview);

            // V4 controls
            document.getElementById('output-format')?.addEventListener('change', updatePromptPreview);
            document.getElementById('strict-source-mode')?.addEventListener('change', updatePromptPreview);

            // V6 controls
            document.getElementById('aspect-ratio-selector')?.addEventListener('change', updatePromptPreview);
            document.getElementById('time-of-day-selector')?.addEventListener('change', updatePromptPreview);
            document.getElementById('custom-props-input')?.addEventListener('input', updatePromptPreview);

            // Props selector
            document.getElementById('props-selector').addEventListener('click', (e) => {
                if (e.target.classList.contains('props-btn')) {
                    selectProp(e.target.dataset.id);
                }
            });

            // Lineart strength radio buttons
            document.querySelectorAll('input[name="lineart-strength"]').forEach(radio => {
                radio.addEventListener('change', updatePromptPreview);
            });

            // V8: Per-character advanced settings event listeners are attached in attachPerCharacterSettingsListeners()

            // Color mode radio buttons
            document.querySelectorAll('input[name="color-mode"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    updateColorMode();
                    updatePromptPreview();
                });
            });

            // Color pickers
            document.getElementById('color-1')?.addEventListener('input', (e) => {
                updateColorHex('color-1', 'color-1-hex');
                updatePromptPreview();
            });
            document.getElementById('color-2')?.addEventListener('input', (e) => {
                updateColorHex('color-2', 'color-2-hex');
                updatePromptPreview();
            });

            // Copy & Save
            document.getElementById('copy-prompt-btn').addEventListener('click', copyPrompt);
            document.getElementById('save-images-btn').addEventListener('click', saveImages);

            // Reference images
            document.getElementById('reference-images').addEventListener('click', (e) => {
                if (e.target.classList.contains('image-preview')) {
                    const index = parseInt(e.target.dataset.index);
                    const modal = document.getElementById('image-viewer-modal');
                    document.getElementById('viewer-image').src = selectedImages[index].data;
                    modal.classList.add('show');
                }
            });

            // Character DB
            document.getElementById('add-character-btn').addEventListener('click', () => openCharacterModal());
            document.getElementById('import-json-btn').addEventListener('click', importJSON);
            document.getElementById('export-json-btn').addEventListener('click', exportJSON);

            document.getElementById('character-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-character')) {
                    openCharacterModal(parseInt(e.target.dataset.id));
                } else if (e.target.classList.contains('delete-character')) {
                    deleteCharacterConfirm(parseInt(e.target.dataset.id));
                }
            });

            // Situation DB (V2)
            document.getElementById('add-situation-btn').addEventListener('click', () => openSituationModal());

            document.getElementById('situation-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-situation')) {
                    openSituationModal(parseInt(e.target.dataset.id));
                } else if (e.target.classList.contains('delete-situation')) {
                    deleteSituationConfirm(parseInt(e.target.dataset.id));
                }
            });

            // Action DB (V2)
            document.getElementById('add-action-btn').addEventListener('click', () => openActionModal());

            document.getElementById('action-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-action')) {
                    openActionModal(parseInt(e.target.dataset.id));
                } else if (e.target.classList.contains('delete-action')) {
                    deleteActionConfirm(parseInt(e.target.dataset.id));
                }
            });

            // Character Form
            document.getElementById('character-form').addEventListener('submit', saveCharacter);
            document.getElementById('character-images').addEventListener('change', (e) => {
                handleImageSelection(e.target.files);
            });

            document.getElementById('image-preview-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-preview-image')) {
                    e.target.parentElement.remove();
                }
            });

            // Situation Form (V2)
            document.getElementById('situation-form').addEventListener('submit', saveSituation);

            // Action Form (V2)
            document.getElementById('action-form').addEventListener('submit', saveAction);

            // Style DB (V5)
            document.getElementById('add-style-btn').addEventListener('click', () => openStyleModal());

            document.getElementById('style-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-style')) {
                    openStyleModal(parseInt(e.target.dataset.id));
                } else if (e.target.classList.contains('delete-style')) {
                    deleteStyleConfirm(parseInt(e.target.dataset.id));
                }
            });

            // Style Form (V5)
            document.getElementById('style-form').addEventListener('submit', saveStyle);

            // Props DB (V6)
            document.getElementById('add-prop-btn').addEventListener('click', () => openPropsModal());

            document.getElementById('props-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-prop')) {
                    openPropsModal(parseInt(e.target.dataset.id));
                } else if (e.target.classList.contains('delete-prop')) {
                    deletePropConfirm(parseInt(e.target.dataset.id));
                }
            });

            // Props Form (V6)
            document.getElementById('props-form').addEventListener('submit', saveProp);

            // Story Mode (V3)
            document.getElementById('add-project-btn').addEventListener('click', () => openProjectModal());
            document.getElementById('project-form').addEventListener('submit', saveProject);
            document.getElementById('back-to-projects').addEventListener('click', loadProjectList);
            document.getElementById('edit-project-btn').addEventListener('click', () => openProjectModal(currentProjectId));
            document.getElementById('delete-project-btn').addEventListener('click', deleteProjectConfirm);
            document.getElementById('add-page-btn').addEventListener('click', addPageToProject);

            // Project list click
            document.getElementById('project-list').addEventListener('click', (e) => {
                const card = e.target.closest('.project-card');
                if (card) {
                    openProject(parseInt(card.dataset.id));
                }
            });

            // Style presets
            document.querySelectorAll('.style-preset').forEach(checkbox => {
                checkbox.addEventListener('change', updateProjectStyles);
            });

            // Pages container (delegation)
            document.getElementById('pages-container').addEventListener('click', (e) => {
                // Accordion toggle
                if (e.target.closest('.page-header') && !e.target.classList.contains('delete-page')) {
                    const pageId = parseInt(e.target.closest('.page-header').dataset.pageId);
                    togglePageAccordion(pageId);
                }

                // Delete page
                if (e.target.classList.contains('delete-page')) {
                    e.stopPropagation();
                    deletePageConfirm(parseInt(e.target.dataset.pageId));
                }

                // Copy page prompt
                if (e.target.classList.contains('copy-page-prompt')) {
                    const pageId = parseInt(e.target.dataset.pageId);
                    // Copy logic here
                    alert('ãƒšãƒ¼ã‚¸ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã¯å®Ÿè£…ä¸­ã§ã™');
                }
            });

            // Page data updates (delegation)
            document.getElementById('pages-container').addEventListener('change', (e) => {
                if (e.target.classList.contains('page-memo')) {
                    updatePageData(parseInt(e.target.dataset.pageId), 'memo', e.target.value);
                } else if (e.target.classList.contains('page-situation')) {
                    updatePageData(parseInt(e.target.dataset.pageId), 'situationId', parseInt(e.target.value) || null);
                } else if (e.target.classList.contains('page-action')) {
                    updatePageData(parseInt(e.target.dataset.pageId), 'actionId', parseInt(e.target.value) || null);
                }
                // V8: Panels per page
                else if (e.target.classList.contains('panels-per-page')) {
                    updatePanelsPerPage(parseInt(e.target.dataset.pageId), parseInt(e.target.value));
                }
                // V8: Panel composition
                else if (e.target.classList.contains('panel-composition')) {
                    updatePanelData(parseInt(e.target.dataset.pageId), parseInt(e.target.dataset.panelIndex), 'composition', e.target.value);
                }
                // V8: Panel background only toggle
                else if (e.target.classList.contains('panel-bg-only')) {
                    updatePanelData(parseInt(e.target.dataset.pageId), parseInt(e.target.dataset.panelIndex), 'isBackgroundOnly', e.target.checked);
                }
            });

            document.getElementById('pages-container').addEventListener('input', (e) => {
                if (e.target.classList.contains('page-custom-action')) {
                    updatePageData(parseInt(e.target.dataset.pageId), 'customAction', e.target.value);
                }
                // V8: Panel character names
                else if (e.target.classList.contains('panel-characters')) {
                    const names = e.target.value.split(',').map(n => n.trim()).filter(n => n);
                    updatePanelData(parseInt(e.target.dataset.pageId), parseInt(e.target.dataset.panelIndex), 'characterNames', names);
                }
                // V8: Panel custom description
                else if (e.target.classList.contains('panel-custom')) {
                    updatePanelData(parseInt(e.target.dataset.pageId), parseInt(e.target.dataset.panelIndex), 'customDescription', e.target.value);
                }
            });

            // Settings
            document.getElementById('save-presets-btn').addEventListener('click', saveSettings);

            // Modal close
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', closeModal);
            });

            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });
            });

            // V9: Bottom Navigation
            document.querySelectorAll('.bottom-nav-item').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });

            // V9: Sync Button
            document.getElementById('sync-button')?.addEventListener('click', () => {
                document.getElementById('firebase-sync-modal').classList.add('show');
            });

            // V9: Costume Management
            document.getElementById('add-costume-btn')?.addEventListener('click', () => showCostumeModal());

            document.getElementById('costume-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const costume = {
                    name: document.getElementById('costume-name').value,
                    fullSet: document.getElementById('costume-fullset').value,
                    top: document.getElementById('costume-top').value,
                    bottom: document.getElementById('costume-bottom').value,
                    accA: document.getElementById('costume-acc-a').value,
                    accB: document.getElementById('costume-acc-b').value
                };

                const id = document.getElementById('costume-id').value;
                if (id) {
                    costume.id = parseInt(id);
                    await updateCostume(costume);
                } else {
                    await addCostume(costume);
                }

                closeModal();
                await loadCostumeList();
            });

            // V9: Costume Selector
            document.getElementById('costume-selector')?.addEventListener('change', updatePromptPreview);

            // V9: History Management
            document.getElementById('show-all-history')?.addEventListener('click', (e) => {
                document.querySelectorAll('#show-all-history, #show-favorites').forEach(btn => {
                    btn.classList.remove('bg-blue-500', 'text-white');
                    btn.classList.add('bg-white', 'text-gray-700');
                });
                e.target.classList.remove('bg-white', 'text-gray-700');
                e.target.classList.add('bg-blue-500', 'text-white');
                loadHistoryList('all');
            });

            document.getElementById('show-favorites')?.addEventListener('click', (e) => {
                document.querySelectorAll('#show-all-history, #show-favorites').forEach(btn => {
                    btn.classList.remove('bg-blue-500', 'text-white');
                    btn.classList.add('bg-white', 'text-gray-700');
                });
                e.target.classList.remove('bg-white', 'text-gray-700');
                e.target.classList.add('bg-blue-500', 'text-white');
                loadHistoryList('favorites');
            });

            document.getElementById('clear-history-btn')?.addEventListener('click', async () => {
                if (confirm('ã™ã¹ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
                    const history = await getAllHistory();
                    for (const item of history) {
                        await deleteHistory(item.id);
                    }
                    await loadHistoryList();
                }
            });

            // V9: Firebase Sync
            document.getElementById('firebase-login-btn')?.addEventListener('click', handleFirebaseLogin);
            document.getElementById('firebase-logout-btn')?.addEventListener('click', handleFirebaseLogout);
            document.getElementById('firebase-upload-btn')?.addEventListener('click', handleFirebaseUpload);
            document.getElementById('firebase-download-btn')?.addEventListener('click', handleFirebaseDownload);

            // V9: Override Copy Prompt to Save History
            const originalCopyBtn = document.getElementById('copy-prompt-btn');
            if (originalCopyBtn) {
                const newCopyBtn = originalCopyBtn.cloneNode(true);
                originalCopyBtn.parentNode.replaceChild(newCopyBtn, originalCopyBtn);

                newCopyBtn.addEventListener('click', async () => {
                    const prompt = document.getElementById('prompt-preview').textContent;
                    await navigator.clipboard.writeText(prompt);

                    // Save to history
                    const charName = selectedCharacters.length > 0
                        ? (await getAllCharacters()).find(c => c.id === selectedCharacters[0])?.name || 'ä¸æ˜'
                        : 'ä¸æ˜';
                    await saveToHistory(prompt, charName);

                    alert('ğŸ“‹ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ!');
                });
            }

            // Initialize (V2)
            await renderGeneratorHub();
            loadSettings();

            // Initialize V6
            await loadStyleCheckboxes();
            await loadStyleList();
            await renderPropsSelector();
            await loadPropsList();
            updateColorMode(); // Initialize color picker visibility

            // V9: Initialize Firebase and Costume Selector
            try {
                initFirebase();
                updateFirebaseUI();
            } catch (e) {
                console.warn('Firebase initialization failed:', e);
            }
            await updateCostumeSelector();
        });

        // ===== PWA Service Worker =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    self.addEventListener('install', (event) => {
                        self.skipWaiting();
                    });

                    self.addEventListener('activate', (event) => {
                        event.waitUntil(clients.claim());
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request).then((response) => {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `;

                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                navigator.serviceWorker.register(swUrl).then(() => {
                    console.log('Service Worker registered');
                }).catch((err) => {
                    console.error('Service Worker registration failed:', err);
                });
            });
        }
    </script>
</body>
</html>
